<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©°éª‹åŒ—ç–†ï¼š11æ—¥å²è¯—è‡ªé©¾æ¢é™©ä¹‹æ—… - äº¤äº’å¼åœ°å›¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .map-container {
            height: 100vh;
        }

        .sidebar {
            height: 100vh;
            overflow-y: auto;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                height: 40vh;
                min-height: 300px;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1000;
                background: white;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .map-container {
                height: 100vh;
            }

            .mobile-layout {
                flex-direction: row;
                /* ä¿æŒåŸæœ‰å¸ƒå±€ï¼Œé€šè¿‡positionæ§åˆ¶ */
            }

            .sidebar-mobile {
                width: 100% !important;
                max-width: 400px;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            /* ç§»åŠ¨ç«¯åœ°ç‚¹é¡¹ç›®ä¼˜åŒ– */
            .location-item {
                padding: 12px 8px;
                margin: 4px 0;
            }

            /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
            .day-item {
                padding: 16px 12px;
                margin-bottom: 8px;
            }

            /* ç§»åŠ¨ç«¯ä¿¡æ¯çª—å£ä¼˜åŒ– */
            .amap-info-content {
                max-width: 280px !important;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                min-height: 250px;
                height: 35vh;
            }

            .sidebar-mobile {
                max-width: 100%;
            }

            /* å°å±å¹•æ–‡å­—ä¼˜åŒ– */
            .day-item h3 {
                font-size: 1rem;
            }

            .day-item h4 {
                font-size: 0.9rem;
            }

            .location-item {
                font-size: 0.85rem;
            }
        }

        /* ä¾§è¾¹æ åˆ‡æ¢åŠ¨ç”» */
        .sidebar-toggle {
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-collapsed {
            transform: translateX(-100%);
        }

        /* å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
        .day-item {
            transition: all 0.3s ease;
        }

        .location-item {
            transition: all 0.2s ease;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* æ·¡å…¥åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* é«˜äº®åŠ¨ç”» */
        .highlight-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Chosen Palette: Map-Friendly Neutrals with blue highlight color for selected elements -->
    <!-- Application Structure Plan: é‡‡ç”¨ä¸¤æ å¸ƒå±€ã€‚å·¦ä¾§ä¸ºæŒ‰å¤©åˆ†ç»„çš„è¡Œç¨‹åˆ—è¡¨ï¼Œå¯ç‚¹å‡»ç­›é€‰ã€‚å³ä¾§ä¸»åŒºåŸŸä¸ºé«˜å¾·åœ°å›¾å®¹å™¨ã€‚æ­¤ç»“æ„èƒ½è®©ç”¨æˆ·æ¸…æ™°åœ°å¯¹ç…§è¡Œç¨‹æ–‡æœ¬å’Œåœ°ç†è·¯çº¿ã€‚åˆ—è¡¨ä¸åœ°å›¾åŒå‘è”åŠ¨ï¼Œæå‡æ¢ç´¢æ•ˆç‡ã€‚ -->
    <!-- Visualization & Content Choices: ä¸»è¦å¯è§†åŒ–ä¸ºé«˜å¾·åœ°å›¾ã€‚ä½¿ç”¨Markeræ ‡è®°åœ°ç‚¹ï¼ŒPolylineç»˜åˆ¶é©¾è½¦è·¯çº¿ã€‚ç‚¹å‡»Markeræ˜¾ç¤ºInfoWindowã€‚ä¾§è¾¹æ åˆ—è¡¨é¡¹ä¸Markerè”åŠ¨ã€‚å¯é€‰ï¼šä½¿ç”¨Chart.jsæ¡å½¢å›¾å±•ç¤ºæ¯æ—¥é¢„è®¡é©¾é©¶é‡Œç¨‹ã€‚ç†ç”±ï¼šè¿™æ˜¯æœ€ç›´æ¥ã€æœ€ç¬¦åˆç”¨æˆ·ç›´è§‰çš„æ—…è¡Œè·¯çº¿å¯è§†åŒ–æ–¹æ¡ˆã€‚ -->
    <!-- CONFIRMATION: Gaode Maps API is the primary visualization tool. NO SVG graphics used. NO Mermaid JS used. -->

    <div class="flex h-screen mobile-layout" id="main-container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="w-1/3 bg-white shadow-lg sidebar sidebar-mobile" id="sidebar">
            <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">é©°éª‹åŒ—ç–†</h1>
                        <p class="text-gray-600">11æ—¥å²è¯—è‡ªé©¾æ¢é™©ä¹‹æ—…</p>
                    </div>
                    <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
                    <button id="sidebar-toggle" class="md:hidden p-2 rounded-lg hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- è¡Œç¨‹ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="text-blue-600 font-medium">æ€»é‡Œç¨‹</div>
                        <div class="text-blue-800 font-bold">çº¦3000å…¬é‡Œ</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="text-green-600 font-medium">æ€»å¤©æ•°</div>
                        <div class="text-green-800 font-bold">11å¤©</div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡å›¾è¡¨åˆ‡æ¢æŒ‰é’® -->
                <div class="mt-4">
                    <button id="toggle-stats"
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm transition-colors">
                        ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡å›¾è¡¨
                    </button>
                </div>

                <!-- ç»Ÿè®¡å›¾è¡¨å®¹å™¨ -->
                <div id="stats-container" class="mt-4 hidden">
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">æ¯æ—¥é©¾é©¶é‡Œç¨‹</h4>
                        <canvas id="distance-chart" width="300" height="200"></canvas>
                    </div>
                    <div class="bg-white border rounded-lg p-4 mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">åœ°ç‚¹ç±»å‹åˆ†å¸ƒ</h4>
                        <canvas id="location-chart" width="300" height="200"></canvas>
                    </div>
                </div>

                <!-- å¿«é€Ÿå¯¼èˆª -->
                <div class="mt-4">
                    <div class="flex flex-wrap gap-2">
                        <button id="quick-nav-all"
                            class="px-3 py-1 bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-full text-sm transition-colors">
                            å…¨éƒ¨è¡Œç¨‹
                        </button>
                        <button id="quick-nav-attractions"
                            class="px-3 py-1 bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-full text-sm transition-colors">
                            ä¸»è¦æ™¯ç‚¹
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¡Œç¨‹åˆ—è¡¨å®¹å™¨ -->
            <div id="itinerary-list" class="p-4">
                <!-- åŠ¨æ€ç”Ÿæˆçš„è¡Œç¨‹åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- å³ä¾§åœ°å›¾å®¹å™¨ -->
        <div class="flex-1 relative">
            <div id="map-container" class="w-full h-full map-container"></div>

            <!-- åœ°å›¾æ§åˆ¶æŒ‰é’®ç»„ -->
            <div class="absolute top-4 right-4 z-10 space-y-2">
                <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ æ˜¾ç¤ºæŒ‰é’® -->
                <button id="mobile-sidebar-toggle"
                    class="md:hidden bg-white hover:bg-gray-50 text-gray-700 p-3 rounded-lg shadow-lg transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>

                <!-- æ˜¾ç¤ºå…¨éƒ¨è¡Œç¨‹æŒ‰é’® -->
                <button id="show-all-days"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg transition-colors">
                    æ˜¾ç¤ºå…¨éƒ¨è¡Œç¨‹
                </button>

                <!-- åœ°å›¾æ ·å¼åˆ‡æ¢æŒ‰é’® -->
                <button id="map-style-toggle"
                    class="bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-lg transition-colors">
                    å«æ˜Ÿåœ°å›¾
                </button>

                <!-- é‡ç½®è§†é‡æŒ‰é’® -->
                <button id="reset-view"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg transition-colors">
                    é‡ç½®è§†é‡
                </button>
            </div>

            <!-- å½“å‰é€‰ä¸­å¤©æ•°ä¿¡æ¯æ˜¾ç¤º -->
            <div id="current-day-info"
                class="absolute bottom-4 left-4 z-10 bg-white rounded-lg shadow-lg p-4 max-w-sm hidden">
                <div id="current-day-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- é«˜å¾·åœ°å›¾API -->
    <script type="text/javascript">
        // APIå¯†é’¥å ä½ç¬¦ - è¯·åœ¨æ­¤å¤„è¾“å…¥æ‚¨çš„é«˜å¾·åœ°å›¾APIå¯†é’¥
        const GAODE_API_KEY = "4a53188fb8c0fd275b28a9f3152816bd";

        // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾API
        function loadGaodeMapAPI() {
            return new Promise((resolve, reject) => {
                if (typeof AMap !== 'undefined') {
                    console.log('é«˜å¾·åœ°å›¾APIå·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨');
                    resolve();
                    return;
                }

                console.log('å¼€å§‹åŠ è½½é«˜å¾·åœ°å›¾API...');
                console.log('APIå¯†é’¥:', GAODE_API_KEY);

                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `https://webapi.amap.com/maps?v=2.0&key=${GAODE_API_KEY}&plugin=AMap.Driving,AMap.Scale,AMap.ToolBar`;

                script.onload = () => {
                    console.log('é«˜å¾·åœ°å›¾APIè„šæœ¬åŠ è½½æˆåŠŸ');
                    if (typeof AMap !== 'undefined') {
                        console.log('AMapå¯¹è±¡å¯ç”¨');
                        resolve();
                    } else {
                        console.error('AMapå¯¹è±¡æœªå®šä¹‰');
                        reject(new Error('AMapå¯¹è±¡æœªå®šä¹‰'));
                    }
                };

                script.onerror = (error) => {
                    console.error('é«˜å¾·åœ°å›¾APIè„šæœ¬åŠ è½½å¤±è´¥:', error);
                    reject(new Error('ç½‘ç»œè¿æ¥å¤±è´¥æˆ–APIå¯†é’¥æ— æ•ˆ'));
                };

                document.head.appendChild(script);
                console.log('é«˜å¾·åœ°å›¾APIè„šæœ¬å·²æ·»åŠ åˆ°é¡µé¢');
            });
        }

        // 11æ—¥åŒ—ç–†è‡ªé©¾è¡Œç¨‹æ•°æ®
        const itineraryData = {
            title: "é©°éª‹åŒ—ç–†ï¼š11æ—¥å²è¯—è‡ªé©¾æ¢é™©ä¹‹æ—…",
            totalDays: 11,
            totalDistance: "çº¦3000å…¬é‡Œ",
            startDate: "2024å¹´8æœˆ12æ—¥",
            endDate: "2024å¹´8æœˆ22æ—¥",
            days: [
                {
                    day: 1,
                    date: "8æœˆ12æ—¥",
                    title: "æŠµè¾¾ä¹Œé²æœ¨é½ - ä¸è·¯ä¹‹é—¨çš„åºæ›²",
                    locations: [
                        {
                            name: "ä¹Œé²æœ¨é½åœ°çªå ¡å›½é™…æœºåœº",
                            type: "airport",
                            coordinates: [87.474411, 43.907105],
                            address: "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒºä¹Œé²æœ¨é½å¸‚æ–°å¸‚åŒº",
                            description: "ä»æ¸©å·é£æŠµä¹Œé²æœ¨é½ï¼ŒåŠç†æè½¦æ‰‹ç»­",
                            time: "ä¸‹åˆ",
                            notes: "æœºåœºæè½¦ï¼Œå¼€å§‹åŒ—ç–†ä¹‹æ—…"
                        },
                        {
                            name: "ä¹Œé²æœ¨é½åº·è±å¾·é…’åº—",
                            type: "hotel",
                            coordinates: [87.617733, 43.792818],
                            address: "ä¹Œé²æœ¨é½å¸‚å¤©å±±åŒº",
                            description: "å…¥ä½é…’åº—ï¼Œäº«ç”¨æ¬¢è¿æ™šå®´ï¼Œå“å°æ–°ç–†ç¾é£Ÿ",
                            time: "æ™šé—´",
                            notes: "æ¨èé­å®¶ç¾Šç¾”è‚‰æˆ–èƒ–è€æ±‰æ¤’éº»é¸¡"
                        }
                    ],
                    drivingDistance: "çº¦30å…¬é‡Œ",
                    drivingTime: "1å°æ—¶",
                    highlights: ["æœºåœºæè½¦", "æ–°ç–†ç¾é£Ÿåˆä½“éªŒ", "é€‚åº”å½“åœ°æ—¶å·®"]
                },
                {
                    day: 2,
                    date: "8æœˆ13æ—¥",
                    title: "ä¹Œé²æœ¨é½ â†’ å¸ƒå°”æ´¥ - äº”å½©æ»©çš„è½æ—¥ç†”é‡‘",
                    locations: [
                        {
                            name: "ä¹Œé²æœ¨é½å¸‚åŒº",
                            type: "departure",
                            coordinates: [87.617733, 43.792818],
                            address: "ä¹Œé²æœ¨é½å¸‚",
                            description: "æ¸…æ™¨å‡ºå‘ï¼Œæ²¿S21æ²™æ¼ é«˜é€Ÿå‘åŒ—è¡Œé©¶",
                            time: "ä¸Šåˆ",
                            notes: "ç©¿è¶Šå¤å°”ç­é€šå¤ç‰¹æ²™æ¼ "
                        },
                        {
                            name: "å¸ƒå°”æ´¥å¿åŸ",
                            type: "city",
                            coordinates: [86.8286, 47.7045],
                            address: "æ–°ç–†é˜¿å‹’æ³°åœ°åŒºå¸ƒå°”æ´¥å¿",
                            description: "æŠµè¾¾ç«¥è¯è¾¹åŸå¸ƒå°”æ´¥ï¼ŒåŠç†é…’åº—å…¥ä½",
                            time: "ä¸‹åˆ",
                            notes: "ç¨ä½œä¼‘æ•´ï¼Œå‡†å¤‡å‰å¾€äº”å½©æ»©"
                        },
                        {
                            name: "äº”å½©æ»©",
                            type: "attraction",
                            coordinates: [86.6833, 47.7667],
                            address: "å¸ƒå°”æ´¥å¿åŸè¥¿åŒ—çº¦24å…¬é‡Œ",
                            description: "æ¬£èµå¤•é˜³ä¸‹çš„é›…ä¸¹åœ°è²Œï¼Œé¢å°”é½æ–¯æ²³ä¸¤å²¸å¯¹æ¯”å¼ºçƒˆ",
                            time: "å‚æ™š",
                            notes: "å»ºè®®æ–°ç–†æ—¶é—´19:30-20:00æŠµè¾¾è§‚æ—¥è½"
                        },
                        {
                            name: "æ²³å ¤å¤œå¸‚",
                            type: "restaurant",
                            coordinates: [86.8286, 47.7045],
                            address: "å¸ƒå°”æ´¥å¿åŸæ²³å ¤",
                            description: "å“å°é¢å°”é½æ–¯æ²³å†·æ°´é±¼çƒ§çƒ¤å’Œå„ç§çƒ¤è‚‰ä¸²",
                            time: "æ™šé—´",
                            notes: "å¸ƒå°”æ´¥ç‰¹è‰²ç¾é£Ÿä½“éªŒ"
                        },
                        {
                            name: "å¸ƒå°”æ´¥å¤œå…‰åŸå‡æ—¥é…’åº—",
                            type: "hotel",
                            coordinates: [86.8286, 47.7045],
                            address: "å¸ƒå°”æ´¥å¿",
                            description: "å…¥ä½å¸ƒå°”æ´¥ï¼Œä¸ºæ˜æ—¥å–€çº³æ–¯ä¹‹è¡Œåšå‡†å¤‡",
                            time: "æ™šé—´",
                            notes: "é«˜è¯„ä»·é…’åº—é€‰æ‹©"
                        }
                    ],
                    drivingDistance: "çº¦650å…¬é‡Œ",
                    drivingTime: "7-8å°æ—¶",
                    highlights: ["æ²™æ¼ é«˜é€Ÿå…¬è·¯", "äº”å½©æ»©æ—¥è½", "å†·æ°´é±¼ç¾é£Ÿ"]
                },
                {
                    day: 3,
                    date: "8æœˆ14æ—¥",
                    title: "å¸ƒå°”æ´¥ â†’ å–€çº³æ–¯å›½å®¶å…¬å›­ - æ¢è®¿ç¥çš„åèŠ±å›­",
                    locations: [
                        {
                            name: "è´¾ç™»å³ª",
                            type: "transfer",
                            coordinates: [87.0167, 48.7167],
                            address: "å–€çº³æ–¯å›½å®¶å…¬å›­é—¨å£",
                            description: "åœè½¦æ¢ä¹˜ï¼Œè´­ä¹°é—¨ç¥¨å’ŒåŒºé—´è½¦ç¥¨",
                            time: "ä¸Šåˆ",
                            notes: "å–€çº³æ–¯é—¨ç¥¨ä¸¤æ—¥æœ‰æ•ˆ"
                        },
                        {
                            name: "ç¥ä»™æ¹¾",
                            type: "attraction",
                            coordinates: [87.0333, 48.7333],
                            address: "å–€çº³æ–¯æ™¯åŒºå†…",
                            description: "å–€çº³æ–¯ä¸‰æ¹¾ä¹‹ä¸€ï¼Œæ™¨é›¾ç¼­ç»•å¦‚ä»™å¢ƒ",
                            time: "ä¸‹åˆ",
                            notes: "å¯å¾’æ­¥æœ¨æ ˆé“è¿‘è·ç¦»è§‚èµ"
                        },
                        {
                            name: "æœˆäº®æ¹¾",
                            type: "attraction",
                            coordinates: [87.0417, 48.7417],
                            address: "å–€çº³æ–¯æ™¯åŒºå†…",
                            description: "å½¢ä¼¼å¼¯æœˆçš„æ¹–æ¹¾ï¼Œæ˜¯å–€çº³æ–¯çš„ç»å…¸æ™¯è§‚",
                            time: "ä¸‹åˆ",
                            notes: "æœ€ä½³æ‹æ‘„ç‚¹ä¹‹ä¸€"
                        },
                        {
                            name: "å§é¾™æ¹¾",
                            type: "attraction",
                            coordinates: [87.0500, 48.7500],
                            address: "å–€çº³æ–¯æ™¯åŒºå†…",
                            description: "æ¹–ä¸­å°å²›å½¢ä¼¼å§é¾™ï¼Œæ¹–æ°´æ¸…æ¾ˆè§åº•",
                            time: "ä¸‹åˆ",
                            notes: "ä¸‰æ¹¾ä¸­æœ€ä¸‹æ¸¸çš„ä¸€ä¸ª"
                        },
                        {
                            name: "è§‚é±¼å°",
                            type: "attraction",
                            coordinates: [87.0583, 48.7583],
                            address: "å–€çº³æ–¯æ¹–è¥¿å²¸å±±é¡¶",
                            description: "ä»é«˜å¤„ä¿¯ç°å–€çº³æ–¯æ¹–å…¨æ™¯ï¼Œéœ‡æ’¼ä¹‹ç¾",
                            time: "å‚æ™š",
                            notes: "éœ€æ¢ä¹˜ä¸“çº¿è½¦ï¼Œæµ·æ‹”2030ç±³"
                        },
                        {
                            name: "å–€çº³æ–¯èŠ±é—´åŠæ°‘å®¿",
                            type: "hotel",
                            coordinates: [87.0417, 48.7417],
                            address: "å–€çº³æ–¯æ™¯åŒºå†…å›¾ç“¦äººæ‘è½",
                            description: "ä½åœ¨æ™¯åŒºå†…ï¼Œé¿å¼€äººæ½®ï¼Œç‹¬äº«æ¸…æ™¨å®é™",
                            time: "æ™šé—´",
                            notes: "å›¾ç“¦äººç‰¹è‰²ä½å®¿"
                        }
                    ],
                    drivingDistance: "çº¦130å…¬é‡Œ",
                    drivingTime: "2.5-3å°æ—¶",
                    highlights: ["å–€çº³æ–¯ä¸‰æ¹¾", "è§‚é±¼å°å…¨æ™¯", "å›¾ç“¦äººæ‘è½"]
                },
                {
                    day: 4,
                    date: "8æœˆ15æ—¥",
                    title: "å–€çº³æ–¯ â†’ ç¦¾æœ¨æ‘ - ç«¥è¯èˆ¬çš„æ‘è½",
                    locations: [
                        {
                            name: "å–€çº³æ–¯æ¹–",
                            type: "attraction",
                            coordinates: [87.0417, 48.7417],
                            address: "å–€çº³æ–¯æ™¯åŒº",
                            description: "æ™¨å…‰ä¸­äº«å—æ¹–æ³Šé™è°§ï¼Œå¯é€‰æ‹©æ¹–ä¸Šæ¸¸èˆ¹",
                            time: "ä¸Šåˆ",
                            notes: "æ¸…æ™¨æ˜¯æœ€ä½³è§‚èµæ—¶é—´"
                        },
                        {
                            name: "ç¦¾æœ¨æ‘",
                            type: "village",
                            coordinates: [87.1167, 48.6833],
                            address: "é˜¿å‹’æ³°åœ°åŒºå¸ƒå°”æ´¥å¿ç¦¾æœ¨ä¹¡",
                            description: "ä¸­å›½æœ€ç¾æ‘è½ä¹‹ä¸€ï¼Œå›¾ç“¦äººèšå±…åœ°",
                            time: "ä¸‹åˆ",
                            notes: "ä»è´¾ç™»å³ªæ¢ä¹˜ä¸“çº¿å·´å£«"
                        },
                        {
                            name: "ç¦¾æœ¨è§‚æ™¯å¹³å°",
                            type: "viewpoint",
                            coordinates: [87.1200, 48.6800],
                            address: "ç¦¾æœ¨æ‘å¯¹é¢å±±å¡",
                            description: "æ‹æ‘„ç¦¾æœ¨å…¨æ™¯å’Œæ—¥è½ç‚ŠçƒŸçš„ç»å…¸æœºä½",
                            time: "å‚æ™š",
                            notes: "å¾’æ­¥ç™»å±±ï¼Œç”°å›­è¯—ç”»èˆ¬ç¾æ™¯"
                        },
                        {
                            name: "ç¦¾æœ¨äº‘å¢…æœ¨å±‹",
                            type: "hotel",
                            coordinates: [87.1167, 48.6833],
                            address: "ç¦¾æœ¨æ‘å†…",
                            description: "ç‹¬å…·ç‰¹è‰²çš„å›¾ç“¦å°æœ¨å±‹ä½å®¿",
                            time: "æ™šé—´",
                            notes: "8æœˆæ—ºå­£ä»·æ ¼è¾ƒé«˜ï¼Œéœ€æå‰é¢„è®¢"
                        }
                    ],
                    drivingDistance: "çº¦60å…¬é‡Œ",
                    drivingTime: "2å°æ—¶",
                    highlights: ["ç¦¾æœ¨æ‘å…¨æ™¯", "å›¾ç“¦å°æœ¨å±‹", "æ—¥è½ç‚ŠçƒŸ"]
                },
                {
                    day: 5,
                    date: "8æœˆ16æ—¥",
                    title: "ç¦¾æœ¨ â†’ ä¹Œå°”ç¦¾ - é­”é¬¼åŸçš„æ—¥è½é­…å½±",
                    locations: [
                        {
                            name: "ç¦¾æœ¨è§‚æ™¯å¹³å°",
                            type: "viewpoint",
                            coordinates: [87.1200, 48.6800],
                            address: "ç¦¾æœ¨æ‘å¯¹é¢å±±å¡",
                            description: "æ—©èµ·æ‹æ‘„ç¦¾æœ¨æ™¨é›¾ï¼Œé˜³å…‰ç©¿é€è–„é›¾æ´’åœ¨æœ¨å±‹ä¸Š",
                            time: "æ¸…æ™¨",
                            notes: "çº¦æ–°ç–†æ—¶é—´6:00ï¼Œå¦‚æ¢¦ä¼¼å¹»"
                        },
                        {
                            name: "ä¹Œå°”ç¦¾ä¸–ç•Œé­”é¬¼åŸ",
                            type: "attraction",
                            coordinates: [85.3167, 46.0833],
                            address: "å…‹æ‹‰ç›ä¾å¸‚ä¹Œå°”ç¦¾åŒº",
                            description: "é£èš€é›…ä¸¹åœ°è²Œç¾¤ï¼Œä¹˜å°ç«è½¦æ·±å…¥æ¢ç´¢",
                            time: "å‚æ™š",
                            notes: "æ—¥è½æ—¶åˆ†æœ€ä½³ï¼Œå…‰å½±è¯¡è°²ç¥ç§˜"
                        },
                        {
                            name: "ä¹Œå°”ç¦¾é•‡",
                            type: "hotel",
                            coordinates: [85.3167, 46.0833],
                            address: "ä¹Œå°”ç¦¾é•‡æˆ–å…‹æ‹‰ç›ä¾å¸‚",
                            description: "ä½å®¿ä¼‘æ¯ï¼Œä¸ºæ˜æ—¥é•¿é€”é©¾é©¶åšå‡†å¤‡",
                            time: "æ™šé—´",
                            notes: "åœ°è²Œä»æ£®æ—è¿‡æ¸¡åˆ°è’æ¼ æˆˆå£"
                        }
                    ],
                    drivingDistance: "çº¦350å…¬é‡Œ",
                    drivingTime: "5-6å°æ—¶",
                    highlights: ["ç¦¾æœ¨æ™¨é›¾", "åœ°è²Œå˜åŒ–", "é­”é¬¼åŸæ—¥è½"]
                },
                {
                    day: 6,
                    date: "8æœˆ17æ—¥",
                    title: "ä¹Œå°”ç¦¾ â†’ èµ›é‡Œæœ¨æ¹– â†’ ä¼Šå® - å¤§è¥¿æ´‹çš„æœ€åä¸€æ»´çœ¼æ³ª",
                    locations: [
                        {
                            name: "èµ›é‡Œæœ¨æ¹–",
                            type: "attraction",
                            coordinates: [81.1500, 44.5833],
                            address: "åšå°”å¡”æ‹‰å·åšä¹å¸‚",
                            description: "é«˜åŸæ¹–æ³Šï¼Œçº¯å‡€è“è‰²æ¹–æ°´é…é›ªå±±èƒŒæ™¯",
                            time: "ä¸‹åˆ",
                            notes: "å»ºè®®ç¯æ¹–ä¸€å‘¨çº¦60å…¬é‡Œ"
                        },
                        {
                            name: "æœå­æ²Ÿå¤§æ¡¥",
                            type: "landmark",
                            coordinates: [81.2833, 44.3167],
                            address: "ä¼ŠçŠå·éœåŸå¿",
                            description: "å®ä¼Ÿçš„ç°ä»£æ¡¥æ¢å·¥ç¨‹ï¼Œè¿æ¥å—åŒ—ç–†",
                            time: "å‚æ™š",
                            notes: "é€”ç»åœ°æ ‡æ€§å»ºç­‘"
                        },
                        {
                            name: "ä¼Šå®ç¦æœ‹å–œæ¥ç™»é…’åº—",
                            type: "hotel",
                            coordinates: [81.3167, 43.9167],
                            address: "ä¼Šå®å¸‚",
                            description: "ä¼ŠçŠæ²³è°·ä¸­å¿ƒåŸå¸‚ï¼Œé…’åº—é€‰æ‹©ä¸°å¯Œ",
                            time: "æ™šé—´",
                            notes: "å›½é™…è¿é”å“ç‰Œé…’åº—"
                        }
                    ],
                    drivingDistance: "çº¦550å…¬é‡Œ",
                    drivingTime: "6-7å°æ—¶",
                    highlights: ["èµ›é‡Œæœ¨æ¹–ç¯æ¹–", "æœå­æ²Ÿå¤§æ¡¥", "ä¼ŠçŠæ²³è°·"]
                },
                {
                    day: 7,
                    date: "8æœˆ18æ—¥",
                    title: "ä¼Šå® â†’ å–€æ‹‰å³»è‰åŸ â†’ ç‰¹å…‹æ–¯ - ç«‹ä½“è‰åŸä¸å…«å¦åŸ",
                    locations: [
                        {
                            name: "å–€æ‹‰å³»è‰åŸ",
                            type: "attraction",
                            coordinates: [81.8333, 43.0833],
                            address: "ä¼ŠçŠå·ç‰¹å…‹æ–¯å¿",
                            description: "äººä½“è‰åŸï¼Œç«‹ä½“çº¿æ¡å’Œå£®é˜”è§†è§‰å†²å‡»",
                            time: "ä¸Šåˆ-ä¸‹åˆ",
                            notes: "ä¹˜åŒºé—´è½¦æ·±å…¥ï¼Œæ‘„å½±å¤©å ‚"
                        },
                        {
                            name: "ç‰¹å…‹æ–¯å¿åŸ",
                            type: "city",
                            coordinates: [81.8333, 43.2167],
                            address: "ä¼ŠçŠå·ç‰¹å…‹æ–¯å¿",
                            description: "ä¸–ç•Œå”¯ä¸€å…«å¦åŸï¼Œæ”¾å°„çŠ¶è¡—é“å¸ƒå±€",
                            time: "å‚æ™š",
                            notes: "åŸå†…æ²¡æœ‰çº¢ç»¿ç¯çš„ç¥å¥‡å¿åŸ"
                        }
                    ],
                    drivingDistance: "çº¦200å…¬é‡Œ",
                    drivingTime: "4-5å°æ—¶",
                    highlights: ["ç«‹ä½“è‰åŸ", "å…«å¦åŸå¸ƒå±€", "æ— çº¢ç»¿ç¯åŸå¸‚"]
                },
                {
                    day: 8,
                    date: "8æœˆ19æ—¥",
                    title: "ç‰¹å…‹æ–¯ â†’ å¤å¡”å¤é“ â†’ æ˜­è‹ - å¤©å±±æ·±å¤„çš„ç§˜å¢ƒä¹‹è·¯",
                    locations: [
                        {
                            name: "å¤å¡”å¤é“",
                            type: "attraction",
                            coordinates: [81.0167, 42.9833],
                            address: "ä¼ŠçŠå·æ˜­è‹å¿å¤å¡”ä¹¡",
                            description: "å¤ä¸ç»¸ä¹‹è·¯ä¸Šçš„é‡è¦é€šé“ï¼Œå¤©å±±æ·±å¤„çš„ç»ç¾å³¡è°·",
                            time: "ä¸Šåˆ-ä¸‹åˆ",
                            notes: "å¾’æ­¥ä½“éªŒå¤é“é£å…‰ï¼Œè§‚èµå¤å¡”æ²³è°·å’Œé›ªå±±"
                        },
                        {
                            name: "æ˜­è‹è‰åŸ",
                            type: "attraction",
                            coordinates: [81.1333, 43.1500],
                            address: "ä¼ŠçŠå·æ˜­è‹å¿",
                            description: "ä¸­å›½æœ€ç¾çš„é«˜å±±è‰ç”¸ä¹‹ä¸€ï¼Œæ²¹èœèŠ±æµ·ï¼ˆå­£èŠ‚æ€§ï¼‰",
                            time: "ä¸‹åˆ",
                            notes: "8æœˆæ­£å€¼æ²¹èœèŠ±ç››å¼€æœŸ"
                        },
                        {
                            name: "æ˜­è‹å¿åŸ",
                            type: "hotel",
                            coordinates: [81.1333, 43.1500],
                            address: "æ˜­è‹å¿",
                            description: "å…¥ä½æ˜­è‹å¿åŸï¼Œä½“éªŒé«˜åŸå°åŸçš„å®é™",
                            time: "æ™šé—´",
                            notes: "æµ·æ‹”è¾ƒé«˜ï¼Œæ³¨æ„ä¿æš–"
                        }
                    ],
                    drivingDistance: "çº¦180å…¬é‡Œ",
                    drivingTime: "3-4å°æ—¶",
                    highlights: ["å¤å¡”å¤é“å¾’æ­¥", "æ˜­è‹æ²¹èœèŠ±æµ·", "å¤©å±±é›ªå³°"]
                },
                {
                    day: 9,
                    date: "8æœˆ20æ—¥",
                    title: "æ˜­è‹ â†’ åº“è½¦ - ç©¿è¶Šå¤©å±±å—åŒ—",
                    locations: [
                        {
                            name: "æ˜­è‹å¿åŸ",
                            type: "departure",
                            coordinates: [81.1333, 43.1500],
                            address: "æ˜­è‹å¿",
                            description: "æ¸…æ™¨å‡ºå‘ï¼Œå‘Šåˆ«ä¼ŠçŠæ²³è°·",
                            time: "ä¸Šåˆ",
                            notes: "å‡†å¤‡é•¿é€”é©¾é©¶ç©¿è¶Šå¤©å±±"
                        },
                        {
                            name: "ç‹¬åº“å…¬è·¯å—æ®µ",
                            type: "road",
                            coordinates: [82.5000, 42.5000],
                            address: "G217å›½é“å—æ®µ",
                            description: "ä»ä¼ŠçŠæ–¹å‘è¿›å…¥ç‹¬åº“å…¬è·¯ï¼Œä½“éªŒå¤©å±±å³¡è°·é£å…‰",
                            time: "å…¨å¤©",
                            notes: "ä¸€æ—¥æ¸¸å››å­£ï¼Œåé‡Œä¸åŒå¤©"
                        },
                        {
                            name: "åº“è½¦å¿åŸ",
                            type: "hotel",
                            coordinates: [82.9667, 41.7167],
                            address: "é˜¿å…‹è‹åœ°åŒºåº“è½¦å¿",
                            description: "æŠµè¾¾åº“è½¦ï¼Œå¤ä¸è·¯é‡é•‡",
                            time: "æ™šé—´",
                            notes: "ä¸ºæ˜æ—¥ç‹¬åº“å…¬è·¯åŒ—æ®µåšå‡†å¤‡"
                        }
                    ],
                    drivingDistance: "çº¦350å…¬é‡Œ",
                    drivingTime: "6-7å°æ—¶",
                    highlights: ["ç‹¬åº“å…¬è·¯å—æ®µ", "å¤©å±±å³¡è°·", "å¤ä¸è·¯é‡é•‡"]
                },
                {
                    day: 10,
                    date: "8æœˆ21æ—¥",
                    title: "åº“è½¦ â†’ å¥å±¯ - é©°éª‹ä¼ å¥‡ç‹¬åº“å…¬è·¯åŒ—æ®µ",
                    locations: [
                        {
                            name: "åº“è½¦å¤§å³¡è°·",
                            type: "attraction",
                            coordinates: [83.0000, 41.7000],
                            address: "åº“è½¦å¿åŸé™„è¿‘",
                            description: "å¤©å±±ç¥ç§˜å¤§å³¡è°·ï¼Œçº¢è‰²ç ‚å²©å³¡è°·å¥‡è§‚",
                            time: "ä¸Šåˆ",
                            notes: "å¯é€‰æ™¯ç‚¹ï¼Œæ—¶é—´å……è£•å¯æ¸¸è§ˆ"
                        },
                        {
                            name: "ç‹¬åº“å…¬è·¯åŒ—æ®µ",
                            type: "road",
                            coordinates: [83.5000, 42.5000],
                            address: "G217å›½é“åŒ—æ®µ",
                            description: "ç»§ç»­ç©¿è¶Šç‹¬åº“å…¬è·¯æœ€ç²¾åçš„åŒ—æ®µ",
                            time: "å…¨å¤©",
                            notes: "é€šè¡Œæ—¶é—´åŒ—äº¬æ—¶é—´9:00-20:00"
                        },
                        {
                            name: "å¤§å°é¾™æ± ",
                            type: "attraction",
                            coordinates: [84.4167, 43.0833],
                            address: "ç‹¬åº“å…¬è·¯æ²¿çº¿",
                            description: "é«˜å±±æ¹–æ³Šï¼Œé€”ç»å†°å·é›ªå²­",
                            time: "é€”ä¸­",
                            notes: "ä¸€æ—¥æ¸¸å››å­£ï¼Œåé‡Œä¸åŒå¤©"
                        },
                        {
                            name: "ç‹¬å±±å­",
                            type: "city",
                            coordinates: [84.8833, 44.3167],
                            address: "å…‹æ‹‰ç›ä¾å¸‚ç‹¬å±±å­åŒº",
                            description: "ç‹¬åº“å…¬è·¯åŒ—ç«¯ç»ˆç‚¹",
                            time: "å‚æ™š",
                            notes: "é©¶å‡ºç‹¬åº“å…¬è·¯"
                        },
                        {
                            name: "å¥å±¯ä¸Šä¸œæ¹–å¤§é…’åº—",
                            type: "hotel",
                            coordinates: [84.9000, 44.4167],
                            address: "å¥å±¯å¸‚",
                            description: "é‡è¦äº¤é€šæ¢çº½ï¼Œä½å®¿é€‰æ‹©è‰¯å¥½",
                            time: "æ™šé—´",
                            notes: "ä¸ºè¿”ç¨‹åšå‡†å¤‡"
                        }
                    ],
                    drivingDistance: "çº¦380å…¬é‡Œ",
                    drivingTime: "7-8å°æ—¶",
                    highlights: ["åº“è½¦å¤§å³¡è°·", "ç‹¬åº“å…¬è·¯åŒ—æ®µ", "å¤§å°é¾™æ± ", "å››å­£å˜æ¢"]
                },
                {
                    day: 11,
                    date: "8æœˆ22æ—¥",
                    title: "å¥å±¯ â†’ ä¹Œé²æœ¨é½ â†’ æ—©ç­æœºè¿”ç¨‹ - åŒ—ç–†ä¹‹æ—…çš„å®Œç¾å¥å·",
                    locations: [
                        {
                            name: "å¥å±¯å¸‚åŒº",
                            type: "departure",
                            coordinates: [84.9000, 44.4167],
                            address: "å¥å±¯å¸‚",
                            description: "æ¸…æ™¨å‡ºå‘å‰å¾€ä¹Œé²æœ¨é½ï¼Œä¸ºæ—©ç­æœºåšå‡†å¤‡",
                            time: "æ¸…æ™¨",
                            notes: "çº¦å‡Œæ™¨4:00å‡ºå‘ï¼Œç¡®ä¿åŠæ—¶åˆ°è¾¾æœºåœº"
                        },
                        {
                            name: "å›½é™…å¤§å·´æ‰ï¼ˆå¯é€‰ï¼‰",
                            type: "shopping",
                            coordinates: [87.6167, 43.8000],
                            address: "ä¹Œé²æœ¨é½å¸‚å¤©å±±åŒº",
                            description: "æ—¶é—´å……è£•å¯å¿«é€Ÿé‡‡è´­ç‰¹äº§çºªå¿µå“",
                            time: "æ—©ä¸Š",
                            notes: "æ ¹æ®æ—¶é—´å®‰æ’ï¼Œå¯é€‰æ‹©æ€§è´­ä¹°"
                        },
                        {
                            name: "ä¹Œé²æœ¨é½åœ°çªå ¡å›½é™…æœºåœº",
                            type: "airport",
                            coordinates: [87.474411, 43.907105],
                            address: "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒºä¹Œé²æœ¨é½å¸‚æ–°å¸‚åŒº",
                            description: "åŠç†è¿˜è½¦æ‰‹ç»­ï¼Œæ­ä¹˜06:35èˆªç­è¿”å›æ¸©å·",
                            time: "æ—©ä¸Š",
                            notes: "06:35èˆªç­ï¼Œéœ€04:00å·¦å³åˆ°è¾¾æœºåœºåŠç†æ‰‹ç»­"
                        }
                    ],
                    drivingDistance: "çº¦280å…¬é‡Œ",
                    drivingTime: "çº¦3.5å°æ—¶",
                    highlights: ["æ—©ç­æœºè¿”ç¨‹", "11æ—¥åŒ—ç–†å®Œç¾æ”¶å®˜", "æ»¡è½½å›å¿†å½’é€”"]
                }
            ]
        };

        // é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
        function showError(title, message, isRetryable = false) {
            const errorHtml = `
                <div class="flex items-center justify-center h-full bg-red-50">
                    <div class="text-center p-8 max-w-md">
                        <div class="text-6xl mb-4">âŒ</div>
                        <h2 class="text-2xl font-bold text-red-700 mb-4">${title}</h2>
                        <p class="text-red-600 mb-4">${message}</p>
                        ${isRetryable ? `
                            <button onclick="location.reload()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                é‡æ–°åŠ è½½
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            document.getElementById('map-container').innerHTML = errorHtml;
        }

        function showApiKeySetup() {
            const setupHtml = `
                <div class="flex items-center justify-center h-full bg-gray-50">
                    <div class="text-center p-8 max-w-lg">
                        <div class="text-6xl mb-4">ğŸ—ºï¸</div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">éœ€è¦é…ç½®é«˜å¾·åœ°å›¾APIå¯†é’¥</h2>
                        <div class="text-left bg-white p-6 rounded-lg shadow-lg mb-6">
                            <h3 class="text-lg font-semibold mb-3">é…ç½®æ­¥éª¤ï¼š</h3>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-600">
                                <li>è®¿é—® <a href="https://console.amap.com/" target="_blank" class="text-blue-500 hover:underline">é«˜å¾·å¼€æ”¾å¹³å°</a></li>
                                <li>æ³¨å†Œå¹¶ç™»å½•è´¦å·</li>
                                <li>åˆ›å»ºæ–°åº”ç”¨ï¼Œé€‰æ‹©"Webç«¯(JS API)"</li>
                                <li>è·å–APIå¯†é’¥(Key)</li>
                                <li>åœ¨ä»£ç ä¸­æ›¿æ¢ <code class="bg-gray-100 px-2 py-1 rounded">GAODE_API_KEY</code> çš„å€¼</li>
                                <li class="text-red-600 font-medium">é‡è¦ï¼šåœ¨é«˜å¾·æ§åˆ¶å°ä¸­è®¾ç½®åŸŸåç™½åå•ï¼ŒåŒ…æ‹¬ localhost å’Œæ‚¨çš„åŸŸå</li>
                            </ol>
                        </div>
                        <div class="text-sm text-gray-500">
                            <p class="mb-2">å½“å‰APIå¯†é’¥çŠ¶æ€ï¼š<span class="text-red-500 font-medium">æœªé…ç½®</span></p>
                            <p>é…ç½®å®Œæˆååˆ·æ–°é¡µé¢å³å¯ä½¿ç”¨</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('map-container').innerHTML = setupHtml;
        }

        // éªŒè¯APIå¯†é’¥æ ¼å¼
        function validateApiKey(key) {
            // é«˜å¾·åœ°å›¾APIå¯†é’¥é€šå¸¸æ˜¯32ä½å­—ç¬¦ä¸²
            return key && key.length >= 20 && key !== "åœ¨æ­¤å¤„è¾“å…¥æ‚¨çš„é«˜å¾·åœ°å›¾APIå¯†é’¥";
        }

        // æµ‹è¯•APIå¯†é’¥æœ‰æ•ˆæ€§
        function testApiKey() {
            console.log('å¼€å§‹æµ‹è¯•APIå¯†é’¥...');

            // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•è¯·æ±‚
            const testUrl = `https://restapi.amap.com/v3/ip?key=${GAODE_API_KEY}`;

            fetch(testUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('APIæµ‹è¯•å“åº”:', data);
                    if (data.status === '1') {
                        alert('APIå¯†é’¥æœ‰æ•ˆï¼é—®é¢˜å¯èƒ½æ˜¯ç½‘ç»œè¿æ¥æˆ–å…¶ä»–åŸå› ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚');
                    } else {
                        alert(`APIå¯†é’¥æµ‹è¯•å¤±è´¥: ${data.info || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                })
                .catch(error => {
                    console.error('APIæµ‹è¯•å¤±è´¥:', error);
                    alert('APIæµ‹è¯•è¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œè¿æ¥é—®é¢˜æˆ–CORSé™åˆ¶ã€‚');
                });
        }

        // åº”ç”¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            try {
                // æ£€æŸ¥APIå¯†é’¥
                if (!validateApiKey(GAODE_API_KEY)) {
                    showApiKeySetup();
                    return;
                }

                // åŠ è½½åœ°å›¾APIå¹¶åˆå§‹åŒ–åº”ç”¨
                loadGaodeMapAPI().then(() => {
                    console.log('é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');

                    // åˆå§‹åŒ–åœ°å›¾
                    initializeMap();

                    // åˆå§‹åŒ–ä¾§è¾¹æ 
                    renderItinerarySidebar();

                    // æ·»åŠ æ§åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                    setupControlButtons();

                    // åˆå§‹åŒ–ç»Ÿè®¡å›¾è¡¨
                    setupStatistics();

                    // è®¾ç½®é”®ç›˜å¿«æ·é”®
                    setupKeyboardShortcuts();

                    // è®¾ç½®æ— éšœç¢åŠŸèƒ½
                    setupAccessibility();

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    console.log('ğŸ‰ æ–°ç–†æ—…è¡Œåœ°å›¾åº”ç”¨åŠ è½½å®Œæˆï¼');
                    console.log('ğŸ’¡ æç¤ºï¼šç‚¹å‡»ä¾§è¾¹æ çš„å¤©æ•°æŸ¥çœ‹æ¯æ—¥è¡Œç¨‹ï¼Œä½¿ç”¨æ•°å­—é”®1-9å¿«é€Ÿåˆ‡æ¢');

                }).catch((error) => {
                    console.error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥:', error);

                    // è¯¦ç»†çš„é”™è¯¯è¯Šæ–­
                    let errorMessage = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIå¯†é’¥é…ç½®';
                    let diagnosticInfo = '';

                    if (error.message && error.message.includes('key')) {
                        errorMessage = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·æ£€æŸ¥å¯†é’¥é…ç½®';
                        diagnosticInfo = `å½“å‰APIå¯†é’¥: ${GAODE_API_KEY.substring(0, 8)}...`;
                    } else if (error.message && error.message.includes('network')) {
                        errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
                        diagnosticInfo = 'æ— æ³•è¿æ¥åˆ°é«˜å¾·åœ°å›¾æœåŠ¡å™¨';
                    } else {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯CORSæˆ–å…¶ä»–ç½‘ç»œé—®é¢˜
                        diagnosticInfo = `é”™è¯¯è¯¦æƒ…: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                    }

                    // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    const detailedErrorHtml = `
                        <div class="flex items-center justify-center h-full bg-red-50">
                            <div class="text-center p-8 max-w-lg">
                                <div class="text-6xl mb-4">âŒ</div>
                                <h2 class="text-2xl font-bold text-red-700 mb-4">åœ°å›¾åŠ è½½å¤±è´¥</h2>
                                <p class="text-red-600 mb-4">${errorMessage}</p>
                                <div class="bg-white p-4 rounded-lg shadow-lg mb-4 text-left">
                                    <h3 class="font-semibold mb-2">è¯Šæ–­ä¿¡æ¯ï¼š</h3>
                                    <p class="text-sm text-gray-600 mb-2">${diagnosticInfo}</p>
                                    <p class="text-sm text-gray-600 mb-2">APIå¯†é’¥é•¿åº¦: ${GAODE_API_KEY.length} å­—ç¬¦</p>
                                    <p class="text-sm text-gray-600">è¯·æ±‚URL: https://webapi.amap.com/maps?v=2.0&key=${GAODE_API_KEY.substring(0, 8)}...</p>
                                </div>
                                <div class="space-y-2">
                                    <button onclick="location.reload()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors mr-2">
                                        é‡æ–°åŠ è½½
                                    </button>
                                    <button onclick="testApiKey()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors mr-2">
                                        æµ‹è¯•APIå¯†é’¥
                                    </button>
                                    <button onclick="window.open('api-test.html', '_blank')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        æ‰“å¼€è¯Šæ–­å·¥å…·
                                    </button>
                                </div>
                                <div class="mt-4 text-sm text-gray-600">
                                    <p><strong>å¸¸è§è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                                    <ul class="list-disc list-inside mt-2 space-y-1">
                                        <li>åœ¨é«˜å¾·æ§åˆ¶å°æ·»åŠ åŸŸåç™½åå•ï¼ˆåŒ…æ‹¬localhostï¼‰</li>
                                        <li>ç¡®ä¿å¯ç”¨äº†JavaScript API v2.0æœåŠ¡</li>
                                        <li>æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®</li>
                                        <li>å°è¯•ä½¿ç”¨HTTPSåè®®è®¿é—®</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('map-container').innerHTML = detailedErrorHtml;
                });

            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥', 'å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
            }
        });

        // æ¸²æŸ“ä¾§è¾¹æ è¡Œç¨‹åˆ—è¡¨
        function renderItinerarySidebar() {
            const container = document.getElementById('itinerary-list');
            let html = '';

            itineraryData.days.forEach(day => {
                html += `
                    <div class="day-item mb-6 p-4 bg-gray-50 rounded-lg hover:bg-blue-50 cursor-pointer transition-colors" data-day="${day.day}">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-800">ç¬¬${day.day}å¤© - ${day.date}</h3>
                            <span class="text-sm text-blue-600">${day.drivingDistance}</span>
                        </div>
                        <h4 class="text-md font-medium text-gray-700 mb-3">${day.title}</h4>
                        
                        <div class="space-y-2">
                            ${day.locations.map(location => `
                                <div class="location-item flex items-start space-x-3 p-2 rounded hover:bg-white transition-colors" data-location="${location.name}">
                                    <div class="location-icon mt-1">
                                        ${getLocationIcon(location.type)}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium text-gray-800">${location.name}</span>
                                            <span class="text-xs text-gray-500">${location.time}</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1">${location.description}</p>
                                        ${location.notes ? `<p class="text-xs text-blue-600 mt-1">${location.notes}</p>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex flex-wrap gap-2">
                                ${day.highlights.map(highlight => `
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">${highlight}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            container.addEventListener('click', function (e) {
                const dayItem = e.target.closest('.day-item');
                const locationItem = e.target.closest('.location-item');

                if (locationItem && !dayItem.classList.contains('bg-blue-100')) {
                    // ç‚¹å‡»åœ°ç‚¹é¡¹ï¼Œé«˜äº®å¯¹åº”çš„åœ°å›¾æ ‡è®°
                    const locationName = locationItem.dataset.location;
                    highlightLocationOnMap(locationName);
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°day-item
                } else if (dayItem) {
                    // ç‚¹å‡»å¤©æ•°é¡¹ï¼Œé€‰æ‹©è¯¥å¤©
                    const dayNumber = parseInt(dayItem.dataset.day);
                    selectDay(dayNumber);
                }
            });

            // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶ç›‘å¬å™¨
            container.addEventListener('mouseover', function (e) {
                const locationItem = e.target.closest('.location-item');
                if (locationItem) {
                    const locationName = locationItem.dataset.location;
                    highlightLocationOnMap(locationName, true); // trueè¡¨ç¤ºåªæ˜¯æ‚¬åœé«˜äº®
                    locationItem.classList.add('bg-blue-50');
                }
            });

            container.addEventListener('mouseout', function (e) {
                const locationItem = e.target.closest('.location-item');
                if (locationItem) {
                    locationItem.classList.remove('bg-blue-50');
                    // å¦‚æœä¸æ˜¯å½“å‰é€‰ä¸­çš„å¤©æ•°ï¼Œæ¸…é™¤åœ°å›¾é«˜äº®
                    const dayItem = locationItem.closest('.day-item');
                    if (!dayItem.classList.contains('bg-blue-100')) {
                        clearMapHighlight();
                    }
                }
            });
        }

        // è·å–åœ°ç‚¹ç±»å‹å¯¹åº”çš„å›¾æ ‡
        function getLocationIcon(type) {
            const icons = {
                'airport': 'âœˆï¸',
                'hotel': 'ğŸ¨',
                'attraction': 'ğŸï¸',
                'restaurant': 'ğŸ½ï¸',
                'city': 'ğŸ™ï¸',
                'village': 'ğŸ˜ï¸',
                'viewpoint': 'ğŸ“¸',
                'transfer': 'ğŸšŒ',
                'departure': 'ğŸš—',
                'road': 'ğŸ›£ï¸',
                'landmark': 'ğŸŒ‰',
                'shopping': 'ğŸ›ï¸'
            };
            return icons[type] || 'ğŸ“';
        }

        // å…¨å±€å˜é‡
        let map = null;
        let mapController = null;
        let currentDay = null;

        // MapControllerç±» - ç®¡ç†æ‰€æœ‰åœ°å›¾æ“ä½œ
        class MapController {
            constructor(containerId) {
                this.map = null;
                this.markers = [];
                this.routes = [];
                this.driving = null;
                this.infoWindows = [];
                this.containerId = containerId;
                this.init();
            }

            // åˆå§‹åŒ–åœ°å›¾
            init() {
                try {
                    // åˆ›å»ºåœ°å›¾å®ä¾‹
                    this.map = new AMap.Map(this.containerId, {
                        zoom: 5.5,
                        center: [87.0, 44.5], // æ–°ç–†åŒ—éƒ¨ä¸­å¿ƒä½ç½®
                        mapStyle: 'amap://styles/normal',
                        viewMode: '2D',
                        pitch: 0,
                        rotation: 0,
                        showLabel: true,
                        features: ['bg', 'road', 'building', 'point'],
                        zooms: [3, 18] // è®¾ç½®ç¼©æ”¾èŒƒå›´
                    });

                    // æ·»åŠ åœ°å›¾æ§ä»¶
                    try {
                        // æ¯”ä¾‹å°ºæ§ä»¶
                        if (AMap.Scale) {
                            this.map.addControl(new AMap.Scale());
                        }

                        // å·¥å…·æ¡æ§ä»¶
                        if (AMap.ToolBar) {
                            this.map.addControl(new AMap.ToolBar({
                                position: {
                                    top: '10px',
                                    left: '10px'
                                }
                            }));
                        }
                    } catch (error) {
                        console.warn('åœ°å›¾æ§ä»¶åˆå§‹åŒ–å¤±è´¥:', error);
                        // æ§ä»¶å¤±è´¥ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œç»§ç»­æ‰§è¡Œ
                    }

                    // åˆå§‹åŒ–é©¾è½¦è·¯çº¿è§„åˆ’æœåŠ¡
                    this.driving = new AMap.Driving({
                        map: this.map,
                        showTraffic: false,
                        hideMarkers: true // éšè—é»˜è®¤çš„èµ·ç»ˆç‚¹æ ‡è®°
                    });

                    // åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
                    this.map.on('complete', () => {
                        console.log('åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
                        // å»¶è¿Ÿæ˜¾ç¤ºæ‰€æœ‰å¤©æ•°ï¼Œç¡®ä¿åœ°å›¾å®Œå…¨åŠ è½½
                        setTimeout(() => {
                            this.displayAllDays();
                        }, 300);
                    });

                    console.log('MapControlleråˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥', 'è¯·æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®');
                }
            }

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            showError(title, message) {
                document.getElementById(this.containerId).innerHTML = `
                    <div class="flex items-center justify-center h-full bg-red-50">
                        <div class="text-center p-8">
                            <div class="text-6xl mb-4">âŒ</div>
                            <h2 class="text-2xl font-bold text-red-700 mb-4">${title}</h2>
                            <p class="text-red-600">${message}</p>
                        </div>
                    </div>
                `;
            }

            // æ¸…é™¤æ‰€æœ‰è¦†ç›–ç‰©
            clearOverlays() {
                try {
                    // æ¸…é™¤æ ‡è®°ç‚¹
                    this.markers.forEach(marker => {
                        if (marker && this.map) {
                            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                            marker.clearEvents();
                            this.map.remove(marker);
                        }
                    });
                    this.markers = [];

                    // æ¸…é™¤è·¯çº¿
                    this.routes.forEach(route => {
                        if (route && this.map) {
                            this.map.remove(route);
                        }
                    });
                    this.routes = [];

                    // æ¸…é™¤ä¿¡æ¯çª—
                    this.infoWindows.forEach(infoWindow => {
                        if (infoWindow) {
                            infoWindow.close();
                        }
                    });
                    this.infoWindows = [];

                    // æ¸…é™¤é©¾è½¦è·¯çº¿
                    if (this.driving) {
                        this.driving.clear();
                    }
                } catch (error) {
                    console.warn('æ¸…é™¤è¦†ç›–ç‰©æ—¶å‘ç”Ÿé”™è¯¯:', error);
                }
            }

            // é”€æ¯MapControllerå®ä¾‹
            destroy() {
                this.clearOverlays();
                if (this.map) {
                    this.map.destroy();
                    this.map = null;
                }
                this.driving = null;
            }

            // æ·»åŠ æ ‡è®°ç‚¹
            addMarker(location, dayNumber) {
                if (!location.coordinates || location.coordinates.length !== 2) {
                    console.warn('åœ°ç‚¹åæ ‡æ— æ•ˆ:', location.name);
                    return null;
                }

                const [lng, lat] = location.coordinates;

                // æ ¹æ®åœ°ç‚¹ç±»å‹é€‰æ‹©å›¾æ ‡
                const iconConfig = this.getMarkerIcon(location.type);

                const marker = new AMap.Marker({
                    position: new AMap.LngLat(lng, lat),
                    title: location.name,
                    icon: new AMap.Icon({
                        image: iconConfig.image,
                        size: new AMap.Size(iconConfig.size, iconConfig.size),
                        imageSize: new AMap.Size(iconConfig.size, iconConfig.size)
                    }),
                    offset: new AMap.Pixel(-iconConfig.size / 2, -iconConfig.size),
                    extData: {
                        location: location,
                        day: dayNumber
                    }
                });

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.on('click', (e) => {
                    this.showInfoWindow(marker, location);
                });

                // æ·»åŠ åˆ°åœ°å›¾
                this.map.add(marker);
                this.markers.push(marker);

                return marker;
            }

            // è·å–æ ‡è®°ç‚¹å›¾æ ‡é…ç½®
            getMarkerIcon(type) {
                const iconConfigs = {
                    'airport': { color: '#FF6B6B', emoji: 'âœˆï¸', size: 32 },
                    'hotel': { color: '#4ECDC4', emoji: 'ğŸ¨', size: 28 },
                    'attraction': { color: '#45B7D1', emoji: 'ğŸï¸', size: 30 },
                    'restaurant': { color: '#FFA07A', emoji: 'ğŸ½ï¸', size: 26 },
                    'city': { color: '#98D8C8', emoji: 'ğŸ™ï¸', size: 28 },
                    'village': { color: '#F7DC6F', emoji: 'ğŸ˜ï¸', size: 26 },
                    'viewpoint': { color: '#BB8FCE', emoji: 'ğŸ“¸', size: 28 },
                    'transfer': { color: '#85C1E9', emoji: 'ğŸšŒ', size: 24 },
                    'departure': { color: '#82E0AA', emoji: 'ğŸš—', size: 26 },
                    'road': { color: '#F8C471', emoji: 'ğŸ›£ï¸', size: 24 },
                    'landmark': { color: '#D7BDE2', emoji: 'ğŸŒ‰', size: 30 },
                    'shopping': { color: '#F9E79F', emoji: 'ğŸ›ï¸', size: 26 }
                };

                const config = iconConfigs[type] || { color: '#95A5A6', emoji: 'ğŸ“', size: 24 };

                // åˆ›å»ºå¸¦emojiçš„SVGå›¾æ ‡
                const svg = `
                    <svg width="${config.size}" height="${config.size + 8}" viewBox="0 0 ${config.size} ${config.size + 8}" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.3)"/>
                            </filter>
                        </defs>
                        <circle cx="${config.size / 2}" cy="${config.size / 2}" r="${config.size / 2 - 2}" fill="${config.color}" stroke="white" stroke-width="2" filter="url(#shadow)"/>
                        <text x="${config.size / 2}" y="${config.size / 2 + 4}" text-anchor="middle" font-size="${config.size * 0.4}" fill="white">${config.emoji}</text>
                        <path d="M${config.size / 2} ${config.size} L${config.size / 2 - 4} ${config.size - 8} L${config.size / 2 + 4} ${config.size - 8} Z" fill="${config.color}" stroke="white" stroke-width="1"/>
                    </svg>
                `;

                return {
                    image: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg))),
                    size: config.size
                };
            }

            // æ˜¾ç¤ºä¿¡æ¯çª—
            showInfoWindow(marker, location) {
                // å…³é—­å…¶ä»–ä¿¡æ¯çª—
                this.infoWindows.forEach(infoWindow => {
                    infoWindow.close();
                });

                // è·å–åœ°ç‚¹ç±»å‹çš„emoji
                const typeEmoji = this.getLocationTypeEmoji(location.type);

                const content = `
                    <div class="p-4 max-w-sm bg-white rounded-lg shadow-lg">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">${typeEmoji}</span>
                            <h3 class="text-lg font-bold text-gray-800">${location.name}</h3>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-start">
                                <span class="font-medium text-gray-600 mr-2 min-w-12">ğŸ“</span>
                                <span class="text-gray-700">${location.address}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-medium text-gray-600 mr-2 min-w-12">â°</span>
                                <span class="text-gray-700">${location.time}</span>
                            </div>
                            <div class="flex items-start">
                                <span class="font-medium text-gray-600 mr-2 min-w-12">ğŸ“</span>
                                <span class="text-gray-700">${location.description}</span>
                            </div>
                            ${location.notes ? `
                                <div class="mt-3 p-2 bg-blue-50 border-l-4 border-blue-400 rounded">
                                    <div class="flex items-start">
                                        <span class="text-blue-600 mr-2">ğŸ’¡</span>
                                        <span class="text-blue-800 text-sm">${location.notes}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                const infoWindow = new AMap.InfoWindow({
                    content: content,
                    offset: new AMap.Pixel(0, -40),
                    closeWhenClickMap: true,
                    autoMove: true
                });

                infoWindow.open(this.map, marker.getPosition());
                this.infoWindows.push(infoWindow);
            }

            // è·å–åœ°ç‚¹ç±»å‹å¯¹åº”çš„emoji
            getLocationTypeEmoji(type) {
                const emojis = {
                    'airport': 'âœˆï¸',
                    'hotel': 'ğŸ¨',
                    'attraction': 'ğŸï¸',
                    'restaurant': 'ğŸ½ï¸',
                    'city': 'ğŸ™ï¸',
                    'village': 'ğŸ˜ï¸',
                    'viewpoint': 'ğŸ“¸',
                    'transfer': 'ğŸšŒ',
                    'departure': 'ğŸš—',
                    'road': 'ğŸ›£ï¸',
                    'landmark': 'ğŸŒ‰',
                    'shopping': 'ğŸ›ï¸'
                };
                return emojis[type] || 'ğŸ“';
            }

            // è·å–é«˜äº®æ ‡è®°å›¾æ ‡é…ç½®
            getHighlightMarkerIcon(type) {
                const iconConfigs = {
                    'airport': { color: '#FF4444', emoji: 'âœˆï¸', size: 36 },
                    'hotel': { color: '#22CCAA', emoji: 'ğŸ¨', size: 32 },
                    'attraction': { color: '#2288DD', emoji: 'ğŸï¸', size: 34 },
                    'restaurant': { color: '#FF8844', emoji: 'ğŸ½ï¸', size: 30 },
                    'city': { color: '#66DD99', emoji: 'ğŸ™ï¸', size: 32 },
                    'village': { color: '#DDCC44', emoji: 'ğŸ˜ï¸', size: 30 },
                    'viewpoint': { color: '#AA66DD', emoji: 'ğŸ“¸', size: 32 },
                    'transfer': { color: '#5599EE', emoji: 'ğŸšŒ', size: 28 },
                    'departure': { color: '#55DD77', emoji: 'ğŸš—', size: 30 },
                    'road': { color: '#DD9944', emoji: 'ğŸ›£ï¸', size: 28 },
                    'landmark': { color: '#BB77DD', emoji: 'ğŸŒ‰', size: 34 },
                    'shopping': { color: '#DDDD44', emoji: 'ğŸ›ï¸', size: 30 }
                };

                const config = iconConfigs[type] || { color: '#666666', emoji: 'ğŸ“', size: 28 };

                // åˆ›å»ºé«˜äº®çš„SVGå›¾æ ‡ï¼ˆæ›´å¤§ã€æ›´äº®ï¼‰
                const svg = `
                    <svg width="${config.size}" height="${config.size + 8}" viewBox="0 0 ${config.size} ${config.size + 8}" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge> 
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0" dy="3" stdDeviation="3" flood-color="rgba(0,0,0,0.4)"/>
                            </filter>
                        </defs>
                        <circle cx="${config.size / 2}" cy="${config.size / 2}" r="${config.size / 2 - 2}" fill="${config.color}" stroke="white" stroke-width="3" filter="url(#shadow) url(#glow)"/>
                        <text x="${config.size / 2}" y="${config.size / 2 + 4}" text-anchor="middle" font-size="${config.size * 0.4}" fill="white">${config.emoji}</text>
                        <path d="M${config.size / 2} ${config.size} L${config.size / 2 - 5} ${config.size - 10} L${config.size / 2 + 5} ${config.size - 10} Z" fill="${config.color}" stroke="white" stroke-width="2"/>
                    </svg>
                `;

                return {
                    image: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg))),
                    size: config.size
                };
            }

            // æ˜¾ç¤ºæ‰€æœ‰å¤©æ•°çš„è¡Œç¨‹
            displayAllDays() {
                this.clearOverlays();

                // æ·»åŠ æ‰€æœ‰åœ°ç‚¹çš„æ ‡è®°
                itineraryData.days.forEach(day => {
                    day.locations.forEach(location => {
                        this.addMarker(location, day.day);
                    });
                });

                // æ˜¾ç¤ºä¸»è¦è·¯çº¿è¿æ¥
                this.displayAllDaysRoutes();

                // è®¾ç½®åœ°å›¾è§†é‡åŒ…å«æ‰€æœ‰æ ‡è®°ç‚¹
                this.fitViewToAllMarkers();
            }

            // æ˜¾ç¤ºç‰¹å®šå¤©æ•°çš„è¡Œç¨‹
            displayDay(dayNumber) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                this.showLoadingState(`æ­£åœ¨åŠ è½½ç¬¬${dayNumber}å¤©è¡Œç¨‹...`);

                // ä½¿ç”¨setTimeoutç¡®ä¿UIæ›´æ–°
                setTimeout(() => {
                    try {
                        this.clearOverlays();

                        const dayData = itineraryData.days.find(day => day.day === dayNumber);
                        if (!dayData) {
                            console.error('æœªæ‰¾åˆ°ç¬¬', dayNumber, 'å¤©çš„æ•°æ®');
                            this.hideLoadingState();
                            return;
                        }

                        // æ·»åŠ å½“å¤©çš„æ ‡è®°ç‚¹
                        const dayMarkers = [];
                        dayData.locations.forEach(location => {
                            const marker = this.addMarker(location, dayNumber);
                            if (marker) {
                                dayMarkers.push(marker);
                            }
                        });

                        // è®¡ç®—å¹¶æ˜¾ç¤ºå½“å¤©çš„é©¾é©¶è·¯çº¿
                        this.calculateDayRoute(dayData, dayNumber);

                        // è®¾ç½®åœ°å›¾è§†é‡åŒ…å«å½“å¤©çš„æ ‡è®°ç‚¹
                        this.fitViewToMarkers(dayMarkers);

                        console.log(`æ˜¾ç¤ºç¬¬${dayNumber}å¤©è¡Œç¨‹:`, dayData.title);

                        // éšè—åŠ è½½çŠ¶æ€
                        setTimeout(() => this.hideLoadingState(), 1000);

                    } catch (error) {
                        console.error('æ˜¾ç¤ºå¤©æ•°è¡Œç¨‹æ—¶å‘ç”Ÿé”™è¯¯:', error);
                        this.hideLoadingState();
                    }
                }, 100);
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoadingState(message = 'åŠ è½½ä¸­...') {
                const loadingDiv = document.getElementById('loading-overlay') || this.createLoadingOverlay();
                loadingDiv.querySelector('.loading-message').textContent = message;
                loadingDiv.classList.remove('hidden');
            }

            // éšè—åŠ è½½çŠ¶æ€
            hideLoadingState() {
                const loadingDiv = document.getElementById('loading-overlay');
                if (loadingDiv) {
                    loadingDiv.classList.add('hidden');
                }
            }

            // åˆ›å»ºåŠ è½½è¦†ç›–å±‚
            createLoadingOverlay() {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-overlay';
                loadingDiv.className = 'absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden';
                loadingDiv.innerHTML = `
                    <div class="text-center">
                        <div class="loading-spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <div class="loading-message text-gray-600">åŠ è½½ä¸­...</div>
                    </div>
                `;
                document.getElementById('map-container').appendChild(loadingDiv);
                return loadingDiv;
            }



            // è°ƒæ•´åœ°å›¾è§†é‡ä»¥åŒ…å«æŒ‡å®šçš„æ ‡è®°ç‚¹ï¼ˆå¸¦åŠ¨ç”»ï¼‰
            fitViewToMarkers(markers) {
                if (!markers || markers.length === 0) return;

                if (markers.length === 1) {
                    // å¦‚æœåªæœ‰ä¸€ä¸ªæ ‡è®°ç‚¹ï¼Œå¹³æ»‘å±…ä¸­æ˜¾ç¤º
                    this.map.setCenter(markers[0].getPosition(), true);
                    this.map.setZoom(10, true);
                } else {
                    // å¤šä¸ªæ ‡è®°ç‚¹ï¼Œå¹³æ»‘è°ƒæ•´è§†é‡åŒ…å«æ‰€æœ‰ç‚¹
                    const bounds = new AMap.Bounds();
                    markers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    this.map.setBounds(bounds, true, [120, 120, 120, 120]);

                    // ç¡®ä¿ç¼©æ”¾çº§åˆ«åˆç†
                    setTimeout(() => {
                        const currentZoom = this.map.getZoom();
                        if (currentZoom < 6) {
                            this.map.setZoom(7, true);
                        } else if (currentZoom > 12) {
                            this.map.setZoom(10, true);
                        }
                    }, 500);
                }
            }

            // å¹³æ»‘è°ƒæ•´åœ°å›¾è§†é‡ä»¥åŒ…å«æ‰€æœ‰æ ‡è®°ç‚¹
            fitViewToAllMarkers() {
                if (this.markers.length === 0) {
                    // å¦‚æœæ²¡æœ‰æ ‡è®°ç‚¹ï¼Œè®¾ç½®é»˜è®¤çš„æ–°ç–†åŒ—éƒ¨è§†é‡
                    this.setOptimalXinjiangView();
                    return;
                }

                const bounds = new AMap.Bounds();
                this.markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });

                // ä½¿ç”¨åŠ¨ç”»æ•ˆæœï¼Œå¹¶è®¾ç½®åˆé€‚çš„è¾¹è·
                this.map.setBounds(bounds, true, [60, 60, 60, 60]);

                // ç¡®ä¿ç¼©æ”¾çº§åˆ«åœ¨åˆç†èŒƒå›´å†…
                setTimeout(() => {
                    const currentZoom = this.map.getZoom();
                    if (currentZoom < 4.5) {
                        this.map.setZoom(5, true);
                    } else if (currentZoom > 8) {
                        this.map.setZoom(7, true);
                    }
                }, 800);
            }

            // è®¾ç½®æœ€ä½³çš„æ–°ç–†è§†é‡
            setOptimalXinjiangView() {
                // æ–°ç–†åŒ—éƒ¨æ—…æ¸¸åŒºåŸŸçš„æœ€ä½³è§†é‡
                const xinjiangBounds = new AMap.Bounds(
                    new AMap.LngLat(80.0, 40.0), // è¥¿å—è§’
                    new AMap.LngLat(95.0, 49.0)  // ä¸œåŒ—è§’
                );

                this.map.setBounds(xinjiangBounds, true, [40, 40, 40, 40]);

                // ç¡®ä¿ç¼©æ”¾çº§åˆ«åˆé€‚
                setTimeout(() => {
                    const currentZoom = this.map.getZoom();
                    if (currentZoom < 5) {
                        this.map.setZoom(5.5, true);
                    }
                }, 500);
            }

            // è®¡ç®—å¹¶æ˜¾ç¤ºå½“å¤©çš„é©¾é©¶è·¯çº¿
            calculateDayRoute(dayData, dayNumber) {
                // è¿‡æ»¤å‡ºæœ‰æ•ˆåæ ‡çš„åœ°ç‚¹
                const validLocations = dayData.locations.filter(location =>
                    location.coordinates && location.coordinates.length === 2
                );

                if (validLocations.length < 2) {
                    console.log(`ç¬¬${dayNumber}å¤©åœ°ç‚¹ä¸è¶³ï¼Œæ— æ³•è®¡ç®—è·¯çº¿`);
                    return;
                }

                // è·å–è·¯çº¿é¢œè‰²
                const routeColor = this.getDayRouteColor(dayNumber);

                // åˆ›å»ºè·¯çº¿ç‚¹æ•°ç»„
                const waypoints = validLocations.map(location =>
                    new AMap.LngLat(location.coordinates[0], location.coordinates[1])
                );

                // å¯¹äºæ–°ç–†çš„é•¿è·ç¦»è·¯çº¿ï¼Œç›´æ¥ä½¿ç”¨ç›´çº¿è¿æ¥æ›´ç¨³å®š
                console.log(`ç¬¬${dayNumber}å¤©ï¼šæ˜¾ç¤ºè·¯çº¿è¿æ¥ï¼ˆ${waypoints.length}ä¸ªåœ°ç‚¹ï¼‰`);
                this.drawStraightLine(waypoints, routeColor, dayNumber);
            }

            // è·å–æ¯å¤©è·¯çº¿çš„é¢œè‰²
            getDayRouteColor(dayNumber) {
                const colors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                    '#F7DC6F', '#BB8FCE', '#85C1E9', '#82E0AA', '#F8C471',
                    '#D7BDE2', '#F9E79F'
                ];
                return colors[(dayNumber - 1) % colors.length];
            }

            // è®¡ç®—å¤šç‚¹è·¯çº¿
            calculateMultiPointRoute(waypoints, color, dayNumber) {
                let completedSegments = 0;
                const totalSegments = waypoints.length - 1;
                let failedSegments = 0;

                for (let i = 0; i < waypoints.length - 1; i++) {
                    const start = waypoints[i];
                    const end = waypoints[i + 1];

                    // åˆ›å»ºæ–°çš„é©¾é©¶è·¯çº¿å®ä¾‹ç”¨äºæ¯æ®µè·¯çº¿
                    const segmentDriving = new AMap.Driving({
                        map: this.map,
                        showTraffic: false,
                        hideMarkers: true,
                        polyOptions: {
                            strokeColor: color,
                            strokeWeight: 4,
                            strokeOpacity: 0.8
                        }
                    });

                    // æ·»åŠ è¶…æ—¶å¤„ç†
                    const timeoutId = setTimeout(() => {
                        console.warn(`ç¬¬${dayNumber}å¤©è·¯çº¿æ®µ ${i + 1} è®¡ç®—è¶…æ—¶ï¼Œä½¿ç”¨ç›´çº¿è¿æ¥`);
                        this.drawStraightLine([start, end], color, dayNumber);
                        failedSegments++;
                    }, 10000); // 10ç§’è¶…æ—¶

                    segmentDriving.search(start, end, [], (status, result) => {
                        clearTimeout(timeoutId);
                        completedSegments++;

                        if (status === 'complete') {
                            // è·¯çº¿è®¡ç®—æˆåŠŸ
                            console.log(`ç¬¬${dayNumber}å¤©è·¯çº¿æ®µ ${i + 1}/${totalSegments} è®¡ç®—å®Œæˆ`);
                        } else {
                            // è·¯çº¿è®¡ç®—å¤±è´¥ï¼Œç»˜åˆ¶ç›´çº¿
                            console.warn(`ç¬¬${dayNumber}å¤©è·¯çº¿æ®µ ${i + 1} è®¡ç®—å¤±è´¥ (${status})ï¼Œä½¿ç”¨ç›´çº¿è¿æ¥`);
                            this.drawStraightLine([start, end], color, dayNumber);
                            failedSegments++;
                        }

                        // æ‰€æœ‰è·¯çº¿æ®µéƒ½å¤„ç†å®Œæˆ
                        if (completedSegments === totalSegments) {
                            if (failedSegments > 0) {
                                console.warn(`ç¬¬${dayNumber}å¤©è·¯çº¿è®¡ç®—å®Œæˆï¼Œå…¶ä¸­${failedSegments}æ®µä½¿ç”¨ç›´çº¿è¿æ¥`);
                            } else {
                                console.log(`ç¬¬${dayNumber}å¤©æ‰€æœ‰è·¯çº¿æ®µè®¡ç®—å®Œæˆ`);
                            }
                        }
                    });
                }
            }

            // ç»˜åˆ¶è·¯çº¿è¿æ¥
            drawStraightLine(waypoints, color, dayNumber) {
                if (waypoints.length < 2) return;

                const polyline = new AMap.Polyline({
                    path: waypoints,
                    strokeColor: color,
                    strokeWeight: 3,
                    strokeOpacity: 0.7,
                    strokeStyle: 'solid',
                    lineJoin: 'round',
                    lineCap: 'round',
                    extData: {
                        day: dayNumber,
                        type: 'route-line'
                    }
                });

                this.map.add(polyline);
                this.routes.push(polyline);

                // è®¡ç®—æ€»è·ç¦»ï¼ˆç›´çº¿è·ç¦»ï¼‰
                let totalDistance = 0;
                for (let i = 0; i < waypoints.length - 1; i++) {
                    const distance = waypoints[i].distance(waypoints[i + 1]);
                    totalDistance += distance;
                }

                console.log(`ç¬¬${dayNumber}å¤©è·¯çº¿ï¼š${waypoints.length}ä¸ªåœ°ç‚¹ï¼Œç›´çº¿è·ç¦»çº¦${(totalDistance / 1000).toFixed(0)}å…¬é‡Œ`);
            }

            // è‡ªå®šä¹‰è·¯çº¿æ ·å¼
            customizeRouteStyle(result, color, dayNumber) {
                if (result.routes && result.routes.length > 0) {
                    const route = result.routes[0];
                    // è¿™é‡Œå¯ä»¥è¿›ä¸€æ­¥è‡ªå®šä¹‰è·¯çº¿æ ·å¼
                    console.log(`ç¬¬${dayNumber}å¤©è·¯çº¿é•¿åº¦: ${(route.distance / 1000).toFixed(1)}å…¬é‡Œ`);
                }
            }

            // æ˜¾ç¤ºæ‰€æœ‰å¤©æ•°çš„è·¯çº¿ï¼ˆç®€åŒ–ç‰ˆï¼‰
            displayAllDaysRoutes() {
                // ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¤©æ•°æ—¶ä¸æ˜¾ç¤ºè¯¦ç»†è·¯çº¿
                // åªæ˜¾ç¤ºä¸»è¦çš„è¿æ¥çº¿
                const mainPoints = [];

                itineraryData.days.forEach(day => {
                    // å–æ¯å¤©çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæœ‰æ•ˆåœ°ç‚¹
                    const validLocations = day.locations.filter(location =>
                        location.coordinates && location.coordinates.length === 2
                    );

                    if (validLocations.length > 0) {
                        mainPoints.push({
                            point: new AMap.LngLat(validLocations[0].coordinates[0], validLocations[0].coordinates[1]),
                            day: day.day
                        });

                        if (validLocations.length > 1) {
                            const lastLocation = validLocations[validLocations.length - 1];
                            mainPoints.push({
                                point: new AMap.LngLat(lastLocation.coordinates[0], lastLocation.coordinates[1]),
                                day: day.day
                            });
                        }
                    }
                });

                // ç»˜åˆ¶ä¸»è¦è·¯çº¿è¿æ¥
                if (mainPoints.length > 1) {
                    const mainRoute = new AMap.Polyline({
                        path: mainPoints.map(p => p.point),
                        strokeColor: '#666666',
                        strokeWeight: 3,
                        strokeOpacity: 0.6,
                        strokeStyle: 'solid'
                    });

                    this.map.add(mainRoute);
                    this.routes.push(mainRoute);
                }
            }

            // é«˜äº®ç‰¹å®šæ ‡è®°ç‚¹
            highlightMarker(locationName) {
                const marker = this.markers.find(m =>
                    m.getExtData().location.name === locationName
                );

                if (marker) {
                    // å±…ä¸­åˆ°æ ‡è®°ç‚¹
                    this.map.setCenter(marker.getPosition());
                    // æ˜¾ç¤ºä¿¡æ¯çª—
                    this.showInfoWindow(marker, marker.getExtData().location);
                }
            }
        }

        // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
        function initializeMap() {
            mapController = new MapController('map-container');
            map = mapController.map; // ä¿æŒå‘åå…¼å®¹

            // æ·»åŠ æ§åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            setupControlButtons();

            // åˆå§‹åŒ–ç»Ÿè®¡å›¾è¡¨
            setupStatistics();
        }

        // æ˜¾ç¤ºæ‰€æœ‰å¤©æ•°çš„è¡Œç¨‹
        function showAllDays() {
            if (!mapController) return;

            // é‡ç½®å½“å‰é€‰ä¸­çš„å¤©æ•°
            currentDay = null;

            // ç§»é™¤æ‰€æœ‰å¤©æ•°çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.day-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'border-blue-300');
                item.classList.add('bg-gray-50');
            });

            // éšè—å½“å‰å¤©æ•°ä¿¡æ¯
            document.getElementById('current-day-info').classList.add('hidden');

            // ä½¿ç”¨MapControlleræ˜¾ç¤ºæ‰€æœ‰å¤©æ•°
            mapController.displayAllDays();

            console.log('æ˜¾ç¤ºå…¨éƒ¨è¡Œç¨‹');
        }

        // è®¾ç½®æ§åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        function setupControlButtons() {
            // æ˜¾ç¤ºå…¨éƒ¨è¡Œç¨‹æŒ‰é’®
            document.getElementById('show-all-days').addEventListener('click', function () {
                showAllDays();
            });

            // å¿«é€Ÿå¯¼èˆªæŒ‰é’®
            document.getElementById('quick-nav-all').addEventListener('click', function () {
                showAllDays();
            });

            document.getElementById('quick-nav-attractions').addEventListener('click', function () {
                showMainAttractions();
            });

            // åœ°å›¾æ ·å¼åˆ‡æ¢æŒ‰é’®
            let issatellite = false;
            document.getElementById('map-style-toggle').addEventListener('click', function () {
                if (mapController && mapController.map) {
                    if (issatellite) {
                        mapController.map.setMapStyle('amap://styles/normal');
                        this.textContent = 'å«æ˜Ÿåœ°å›¾';
                        issatellite = false;
                    } else {
                        mapController.map.setMapStyle('amap://styles/satellite');
                        this.textContent = 'æ ‡å‡†åœ°å›¾';
                        issatellite = true;
                    }
                }
            });

            // é‡ç½®è§†é‡æŒ‰é’®
            document.getElementById('reset-view').addEventListener('click', function () {
                if (mapController) {
                    console.log('é‡ç½®åœ°å›¾è§†é‡åˆ°æ–°ç–†åŒ—éƒ¨åŒºåŸŸ');
                    mapController.setOptimalXinjiangView();
                }
            });

            // ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢
            setupMobileSidebar();
        }

        // è®¾ç½®ç§»åŠ¨ç«¯ä¾§è¾¹æ åŠŸèƒ½
        function setupMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mobileToggle = document.getElementById('mobile-sidebar-toggle');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mainContainer = document.getElementById('main-container');

            // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            function isMobile() {
                return window.innerWidth <= 768;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºè§¦æ‘¸è®¾å¤‡
            function isTouchDevice() {
                return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            }

            // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º
            function toggleSidebar() {
                if (isMobile()) {
                    sidebar.classList.toggle('sidebar-collapsed');
                }
            }

            // ç§»åŠ¨ç«¯æ˜¾ç¤ºä¾§è¾¹æ æŒ‰é’®
            mobileToggle.addEventListener('click', function (e) {
                e.preventDefault();
                if (isMobile()) {
                    sidebar.classList.remove('sidebar-collapsed');
                }
            });

            // ä¾§è¾¹æ å…³é—­æŒ‰é’®
            sidebarToggle.addEventListener('click', function (e) {
                e.preventDefault();
                if (isMobile()) {
                    sidebar.classList.add('sidebar-collapsed');
                }
            });

            // è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
            if (isTouchDevice()) {
                let startX = 0;
                let startY = 0;
                let isScrolling = false;

                // ä¾§è¾¹æ æ»‘åŠ¨æ‰‹åŠ¿
                sidebar.addEventListener('touchstart', function (e) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    isScrolling = false;
                }, { passive: true });

                sidebar.addEventListener('touchmove', function (e) {
                    if (!startX || !startY) return;

                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const diffX = startX - currentX;
                    const diffY = startY - currentY;

                    // åˆ¤æ–­æ˜¯å¦ä¸ºæ°´å¹³æ»‘åŠ¨
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        isScrolling = false;
                        // å‘å·¦æ»‘åŠ¨å…³é—­ä¾§è¾¹æ 
                        if (diffX > 50 && isMobile()) {
                            sidebar.classList.add('sidebar-collapsed');
                        }
                    } else {
                        isScrolling = true;
                    }
                }, { passive: true });

                // åœ°å›¾åŒºåŸŸå³æ»‘æ˜¾ç¤ºä¾§è¾¹æ 
                const mapContainer = document.getElementById('map-container');
                mapContainer.addEventListener('touchstart', function (e) {
                    if (!isMobile()) return;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });

                mapContainer.addEventListener('touchmove', function (e) {
                    if (!isMobile() || !startX) return;

                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const diffX = currentX - startX;
                    const diffY = startY - currentY;

                    // ä»å·¦è¾¹ç¼˜å³æ»‘æ˜¾ç¤ºä¾§è¾¹æ 
                    if (startX < 50 && diffX > 100 && Math.abs(diffY) < 50) {
                        sidebar.classList.remove('sidebar-collapsed');
                    }
                }, { passive: true });
            }

            // ç‚¹å‡»åœ°å›¾åŒºåŸŸå…³é—­ä¾§è¾¹æ 
            document.getElementById('map-container').addEventListener('click', function () {
                if (isMobile() && !sidebar.classList.contains('sidebar-collapsed')) {
                    sidebar.classList.add('sidebar-collapsed');
                }
            });

            // çª—å£å¤§å°æ”¹å˜æ—¶çš„å¤„ç†
            window.addEventListener('resize', function () {
                if (!isMobile()) {
                    sidebar.classList.remove('sidebar-collapsed');
                } else {
                    // ç§»åŠ¨ç«¯é»˜è®¤éšè—ä¾§è¾¹æ 
                    if (!sidebar.classList.contains('sidebar-collapsed')) {
                        sidebar.classList.add('sidebar-collapsed');
                    }
                }
            });

            // åˆå§‹åŒ–ç§»åŠ¨ç«¯çŠ¶æ€
            if (isMobile()) {
                sidebar.classList.add('sidebar-collapsed');
            }

            // ä¼˜åŒ–ç§»åŠ¨ç«¯åœ°å›¾äº¤äº’
            if (isTouchDevice() && mapController) {
                // ç¦ç”¨åœ°å›¾çš„æŸäº›æ‰‹åŠ¿ä»¥é¿å…å†²çª
                mapController.map.setStatus({
                    doubleClickZoom: false, // ç¦ç”¨åŒå‡»ç¼©æ”¾ï¼Œé¿å…è¯¯è§¦
                });
            }
        }

        // è®¾ç½®ç»Ÿè®¡å›¾è¡¨åŠŸèƒ½
        function setupStatistics() {
            const toggleButton = document.getElementById('toggle-stats');
            const statsContainer = document.getElementById('stats-container');
            let chartsInitialized = false;

            toggleButton.addEventListener('click', function () {
                if (statsContainer.classList.contains('hidden')) {
                    statsContainer.classList.remove('hidden');
                    toggleButton.textContent = 'ğŸ“Š éšè—ç»Ÿè®¡å›¾è¡¨';

                    if (!chartsInitialized) {
                        initializeCharts();
                        chartsInitialized = true;
                    }
                } else {
                    statsContainer.classList.add('hidden');
                    toggleButton.textContent = 'ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡å›¾è¡¨';
                }
            });
        }

        // åˆå§‹åŒ–ç»Ÿè®¡å›¾è¡¨
        function initializeCharts() {
            createDistanceChart();
            createLocationTypeChart();
        }

        // åˆ›å»ºæ¯æ—¥é©¾é©¶é‡Œç¨‹å›¾è¡¨
        function createDistanceChart() {
            const ctx = document.getElementById('distance-chart').getContext('2d');

            // æå–æ¯æ—¥é©¾é©¶é‡Œç¨‹æ•°æ®
            const labels = [];
            const distances = [];

            itineraryData.days.forEach(day => {
                labels.push(`ç¬¬${day.day}å¤©`);
                // ä»é©¾é©¶è·ç¦»å­—ç¬¦ä¸²ä¸­æå–æ•°å­—
                const distanceMatch = day.drivingDistance.match(/(\d+)/);
                const distance = distanceMatch ? parseInt(distanceMatch[1]) : 0;
                distances.push(distance);
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é©¾é©¶é‡Œç¨‹ (å…¬é‡Œ)',
                        data: distances,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // åˆ›å»ºåœ°ç‚¹ç±»å‹åˆ†å¸ƒå›¾è¡¨
        function createLocationTypeChart() {
            const ctx = document.getElementById('location-chart').getContext('2d');

            // ç»Ÿè®¡åœ°ç‚¹ç±»å‹
            const locationTypes = {};
            const typeNames = {
                'airport': 'æœºåœº',
                'hotel': 'é…’åº—',
                'attraction': 'æ™¯ç‚¹',
                'restaurant': 'é¤å…',
                'city': 'åŸå¸‚',
                'village': 'æ‘è½',
                'viewpoint': 'è§‚æ™¯ç‚¹',
                'transfer': 'ä¸­è½¬ç«™',
                'departure': 'å‡ºå‘ç‚¹',
                'road': 'é“è·¯',
                'landmark': 'åœ°æ ‡',
                'shopping': 'è´­ç‰©'
            };

            itineraryData.days.forEach(day => {
                day.locations.forEach(location => {
                    const typeName = typeNames[location.type] || location.type;
                    locationTypes[typeName] = (locationTypes[typeName] || 0) + 1;
                });
            });

            const labels = Object.keys(locationTypes);
            const data = Object.values(locationTypes);
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E9', '#82E0AA', '#F8C471',
                '#D7BDE2', '#F9E79F'
            ];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                },
                                padding: 10,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // æ˜¾ç¤ºä¸»è¦æ™¯ç‚¹
        function showMainAttractions() {
            if (!mapController) return;

            // é‡ç½®é€‰ä¸­çŠ¶æ€
            currentDay = null;
            document.querySelectorAll('.day-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'border-blue-300');
                item.classList.add('bg-gray-50');
            });

            // æ¸…é™¤è¦†ç›–ç‰©
            mapController.clearOverlays();

            // åªæ˜¾ç¤ºä¸»è¦æ™¯ç‚¹
            const mainAttractions = [];
            itineraryData.days.forEach(day => {
                day.locations.forEach(location => {
                    if (location.type === 'attraction' && location.coordinates) {
                        mapController.addMarker(location, day.day);
                        mainAttractions.push(location);
                    }
                });
            });

            // è°ƒæ•´è§†é‡
            mapController.fitViewToAllMarkers();

            console.log('æ˜¾ç¤ºä¸»è¦æ™¯ç‚¹ï¼Œå…±', mainAttractions.length, 'ä¸ª');
        }

        // é€‰æ‹©ç‰¹å®šå¤©æ•°
        function selectDay(dayNumber) {
            if (!mapController) return;

            currentDay = dayNumber;

            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.day-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'border-blue-300');
                item.classList.add('bg-gray-50');
            });

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            const selectedItem = document.querySelector(`[data-day="${dayNumber}"]`);
            if (selectedItem) {
                selectedItem.classList.remove('bg-gray-50');
                selectedItem.classList.add('bg-blue-100', 'border-blue-300');
            }

            // ä½¿ç”¨MapControlleræ˜¾ç¤ºç‰¹å®šå¤©æ•°
            mapController.displayDay(dayNumber);

            // æ›´æ–°å½“å‰å¤©æ•°ä¿¡æ¯æ˜¾ç¤º
            updateCurrentDayInfo(dayNumber);

            // ç§»åŠ¨ç«¯è‡ªåŠ¨éšè—ä¾§è¾¹æ 
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.add('sidebar-collapsed');
            }
        }

        // æ›´æ–°å½“å‰å¤©æ•°ä¿¡æ¯æ˜¾ç¤º
        function updateCurrentDayInfo(dayNumber) {
            const dayData = itineraryData.days.find(day => day.day === dayNumber);
            const infoDiv = document.getElementById('current-day-info');
            const contentDiv = document.getElementById('current-day-content');

            if (dayData) {
                contentDiv.innerHTML = `
                    <div class="text-sm">
                        <div class="font-bold text-gray-800 mb-1">ç¬¬${dayData.day}å¤© - ${dayData.date}</div>
                        <div class="text-gray-600 mb-2">${dayData.title}</div>
                        <div class="flex items-center text-xs text-gray-500">
                            <span class="mr-3">ğŸš— ${dayData.drivingDistance}</span>
                            <span>â±ï¸ ${dayData.drivingTime}</span>
                        </div>
                    </div>
                `;
                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        // é«˜äº®åœ°å›¾ä¸Šçš„åœ°ç‚¹
        function highlightLocationOnMap(locationName, isHover = false) {
            if (!mapController) return;

            const marker = mapController.markers.find(m =>
                m.getExtData().location.name === locationName
            );

            if (marker) {
                if (isHover) {
                    // æ‚¬åœæ—¶åªå±…ä¸­ï¼Œä¸æ˜¾ç¤ºä¿¡æ¯çª—
                    mapController.map.setCenter(marker.getPosition(), true);

                    // æ·»åŠ ä¸´æ—¶é«˜äº®æ•ˆæœ
                    const originalIcon = marker.getIcon();
                    const location = marker.getExtData().location;
                    const highlightIcon = mapController.getHighlightMarkerIcon(location.type);
                    marker.setIcon(new AMap.Icon({
                        image: highlightIcon.image,
                        size: new AMap.Size(highlightIcon.size, highlightIcon.size),
                        imageSize: new AMap.Size(highlightIcon.size, highlightIcon.size)
                    }));

                    // å­˜å‚¨åŸå§‹å›¾æ ‡ä»¥ä¾¿æ¢å¤
                    marker.originalIcon = originalIcon;
                } else {
                    // ç‚¹å‡»æ—¶å±…ä¸­å¹¶æ˜¾ç¤ºä¿¡æ¯çª—
                    mapController.map.setCenter(marker.getPosition(), true);
                    mapController.showInfoWindow(marker, marker.getExtData().location);
                }
            }
        }

        // æ¸…é™¤åœ°å›¾é«˜äº®
        function clearMapHighlight() {
            if (!mapController) return;

            // æ¢å¤æ‰€æœ‰æ ‡è®°çš„åŸå§‹å›¾æ ‡
            mapController.markers.forEach(marker => {
                if (marker.originalIcon) {
                    marker.setIcon(marker.originalIcon);
                    delete marker.originalIcon;
                }
            });
        }

        // è®¾ç½®é”®ç›˜å¿«æ·é”®
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function (e) {
                // æ•°å­—é”®1-9é€‰æ‹©å¯¹åº”å¤©æ•°
                if (e.key >= '1' && e.key <= '9') {
                    const dayNumber = parseInt(e.key);
                    if (dayNumber <= itineraryData.totalDays) {
                        selectDay(dayNumber);
                    }
                }

                // æ•°å­—é”®0æ˜¾ç¤ºå…¨éƒ¨è¡Œç¨‹
                if (e.key === '0') {
                    showAllDays();
                }

                // ESCé”®å…³é—­ä¿¡æ¯çª—å£å’Œä¾§è¾¹æ 
                if (e.key === 'Escape') {
                    if (mapController) {
                        mapController.infoWindows.forEach(infoWindow => {
                            infoWindow.close();
                        });
                    }

                    // ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.add('sidebar-collapsed');
                    }
                }

                // å·¦å³ç®­å¤´é”®åˆ‡æ¢å¤©æ•°
                if (currentDay && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                    e.preventDefault();
                    let newDay = currentDay;

                    if (e.key === 'ArrowLeft' && currentDay > 1) {
                        newDay = currentDay - 1;
                    } else if (e.key === 'ArrowRight' && currentDay < itineraryData.totalDays) {
                        newDay = currentDay + 1;
                    }

                    if (newDay !== currentDay) {
                        selectDay(newDay);
                    }
                }
            });
        }

        // è®¾ç½®æ— éšœç¢åŠŸèƒ½
        function setupAccessibility() {
            // ä¸ºæ‰€æœ‰äº¤äº’å…ƒç´ æ·»åŠ é€‚å½“çš„ARIAæ ‡ç­¾
            document.querySelectorAll('.day-item').forEach((item, index) => {
                item.setAttribute('role', 'button');
                item.setAttribute('tabindex', '0');
                item.setAttribute('aria-label', `é€‰æ‹©ç¬¬${index + 1}å¤©è¡Œç¨‹`);

                // æ·»åŠ é”®ç›˜å¯¼èˆªæ”¯æŒ
                item.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const dayNumber = parseInt(item.dataset.day);
                        selectDay(dayNumber);
                    }
                });
            });

            // ä¸ºæ§åˆ¶æŒ‰é’®æ·»åŠ ARIAæ ‡ç­¾
            document.getElementById('show-all-days').setAttribute('aria-label', 'æ˜¾ç¤ºå…¨éƒ¨12å¤©è¡Œç¨‹');
            document.getElementById('map-style-toggle').setAttribute('aria-label', 'åˆ‡æ¢åœ°å›¾æ ·å¼');

            // ä¸ºåœ°å›¾å®¹å™¨æ·»åŠ ARIAæ ‡ç­¾
            document.getElementById('map-container').setAttribute('role', 'application');
            document.getElementById('map-container').setAttribute('aria-label', 'æ–°ç–†12æ—¥è‡ªé©¾æ¸¸äº¤äº’å¼åœ°å›¾');

            // æ·»åŠ è·³è¿‡é“¾æ¥ï¼ˆå¯¹å±å¹•é˜…è¯»å™¨å‹å¥½ï¼‰
            const skipLink = document.createElement('a');
            skipLink.href = '#map-container';
            skipLink.textContent = 'è·³è½¬åˆ°åœ°å›¾';
            skipLink.className = 'sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-500 text-white px-4 py-2 rounded z-50';
            document.body.insertBefore(skipLink, document.body.firstChild);
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function () {
            if (mapController) {
                mapController.destroy();
            }
        });

    </script>
</body>

</html>