<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>驰骋北疆：11日史诗自驾探险之旅 - 交互式地图</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .map-container {
            height: 100vh;
        }

        .sidebar {
            height: 100vh;
            overflow-y: auto;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                height: 40vh;
                min-height: 300px;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1000;
                background: white;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .map-container {
                height: 100vh;
            }

            .mobile-layout {
                flex-direction: row;
                /* 保持原有布局，通过position控制 */
            }

            .sidebar-mobile {
                width: 100% !important;
                max-width: 400px;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            /* 移动端地点项目优化 */
            .location-item {
                padding: 12px 8px;
                margin: 4px 0;
            }

            /* 移动端按钮优化 */
            .day-item {
                padding: 16px 12px;
                margin-bottom: 8px;
            }

            /* 移动端信息窗口优化 */
            .amap-info-content {
                max-width: 280px !important;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                min-height: 250px;
                height: 35vh;
            }

            .sidebar-mobile {
                max-width: 100%;
            }

            /* 小屏幕文字优化 */
            .day-item h3 {
                font-size: 1rem;
            }

            .day-item h4 {
                font-size: 0.9rem;
            }

            .location-item {
                font-size: 0.85rem;
            }
        }

        /* 侧边栏切换动画 */
        .sidebar-toggle {
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-collapsed {
            transform: translateX(-100%);
        }

        /* 平滑过渡动画 */
        .day-item {
            transition: all 0.3s ease;
        }

        .location-item {
            transition: all 0.2s ease;
        }

        /* 加载动画 */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* 淡入动画 */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 高亮动画 */
        .highlight-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* 滚动条样式 */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Chosen Palette: Map-Friendly Neutrals with blue highlight color for selected elements -->
    <!-- Application Structure Plan: 采用两栏布局。左侧为按天分组的行程列表，可点击筛选。右侧主区域为高德地图容器。此结构能让用户清晰地对照行程文本和地理路线。列表与地图双向联动，提升探索效率。 -->
    <!-- Visualization & Content Choices: 主要可视化为高德地图。使用Marker标记地点，Polyline绘制驾车路线。点击Marker显示InfoWindow。侧边栏列表项与Marker联动。可选：使用Chart.js条形图展示每日预计驾驶里程。理由：这是最直接、最符合用户直觉的旅行路线可视化方案。 -->
    <!-- CONFIRMATION: Gaode Maps API is the primary visualization tool. NO SVG graphics used. NO Mermaid JS used. -->

    <div class="flex h-screen mobile-layout" id="main-container">
        <!-- 左侧边栏 -->
        <div class="w-1/3 bg-white shadow-lg sidebar sidebar-mobile" id="sidebar">
            <!-- 侧边栏头部 -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">驰骋北疆</h1>
                        <p class="text-gray-600">11日史诗自驾探险之旅</p>
                    </div>
                    <!-- 移动端侧边栏切换按钮 -->
                    <button id="sidebar-toggle" class="md:hidden p-2 rounded-lg hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- 行程统计信息 -->
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="text-blue-600 font-medium">总里程</div>
                        <div class="text-blue-800 font-bold">约3000公里</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="text-green-600 font-medium">总天数</div>
                        <div class="text-green-800 font-bold">11天</div>
                    </div>
                </div>

                <!-- 统计图表切换按钮 -->
                <div class="mt-4">
                    <button id="toggle-stats"
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm transition-colors">
                        📊 显示统计图表
                    </button>
                </div>

                <!-- 统计图表容器 -->
                <div id="stats-container" class="mt-4 hidden">
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">每日驾驶里程</h4>
                        <canvas id="distance-chart" width="300" height="200"></canvas>
                    </div>
                    <div class="bg-white border rounded-lg p-4 mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">地点类型分布</h4>
                        <canvas id="location-chart" width="300" height="200"></canvas>
                    </div>
                </div>

                <!-- 快速导航 -->
                <div class="mt-4">
                    <div class="flex flex-wrap gap-2">
                        <button id="quick-nav-all"
                            class="px-3 py-1 bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-full text-sm transition-colors">
                            全部行程
                        </button>
                        <button id="quick-nav-attractions"
                            class="px-3 py-1 bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-full text-sm transition-colors">
                            主要景点
                        </button>
                    </div>
                </div>
            </div>

            <!-- 行程列表容器 -->
            <div id="itinerary-list" class="p-4">
                <!-- 动态生成的行程列表将在这里显示 -->
            </div>
        </div>

        <!-- 右侧地图容器 -->
        <div class="flex-1 relative">
            <div id="map-container" class="w-full h-full map-container"></div>

            <!-- 地图控制按钮组 -->
            <div class="absolute top-4 right-4 z-10 space-y-2">
                <!-- 移动端侧边栏显示按钮 -->
                <button id="mobile-sidebar-toggle"
                    class="md:hidden bg-white hover:bg-gray-50 text-gray-700 p-3 rounded-lg shadow-lg transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>

                <!-- 显示全部行程按钮 -->
                <button id="show-all-days"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg transition-colors">
                    显示全部行程
                </button>

                <!-- 地图样式切换按钮 -->
                <button id="map-style-toggle"
                    class="bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-lg transition-colors">
                    卫星地图
                </button>

                <!-- 重置视野按钮 -->
                <button id="reset-view"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg transition-colors">
                    重置视野
                </button>
            </div>

            <!-- 当前选中天数信息显示 -->
            <div id="current-day-info"
                class="absolute bottom-4 left-4 z-10 bg-white rounded-lg shadow-lg p-4 max-w-sm hidden">
                <div id="current-day-content">
                    <!-- 动态内容 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 高德地图API -->
    <script type="text/javascript">
        // API密钥占位符 - 请在此处输入您的高德地图API密钥
        const GAODE_API_KEY = "4a53188fb8c0fd275b28a9f3152816bd";

        // 动态加载高德地图API
        function loadGaodeMapAPI() {
            return new Promise((resolve, reject) => {
                if (typeof AMap !== 'undefined') {
                    console.log('高德地图API已存在，直接使用');
                    resolve();
                    return;
                }

                console.log('开始加载高德地图API...');
                console.log('API密钥:', GAODE_API_KEY);

                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `https://webapi.amap.com/maps?v=2.0&key=${GAODE_API_KEY}&plugin=AMap.Driving,AMap.Scale,AMap.ToolBar`;

                script.onload = () => {
                    console.log('高德地图API脚本加载成功');
                    if (typeof AMap !== 'undefined') {
                        console.log('AMap对象可用');
                        resolve();
                    } else {
                        console.error('AMap对象未定义');
                        reject(new Error('AMap对象未定义'));
                    }
                };

                script.onerror = (error) => {
                    console.error('高德地图API脚本加载失败:', error);
                    reject(new Error('网络连接失败或API密钥无效'));
                };

                document.head.appendChild(script);
                console.log('高德地图API脚本已添加到页面');
            });
        }

        // 11日北疆自驾行程数据
        const itineraryData = {
            title: "驰骋北疆：11日史诗自驾探险之旅",
            totalDays: 11,
            totalDistance: "约3000公里",
            startDate: "2024年8月12日",
            endDate: "2024年8月22日",
            days: [
                {
                    day: 1,
                    date: "8月12日",
                    title: "抵达乌鲁木齐 - 丝路之门的序曲",
                    locations: [
                        {
                            name: "乌鲁木齐地窝堡国际机场",
                            type: "airport",
                            coordinates: [87.474411, 43.907105],
                            address: "新疆维吾尔自治区乌鲁木齐市新市区",
                            description: "从温州飞抵乌鲁木齐，办理提车手续",
                            time: "下午",
                            notes: "机场提车，开始北疆之旅"
                        },
                        {
                            name: "乌鲁木齐康莱德酒店",
                            type: "hotel",
                            coordinates: [87.617733, 43.792818],
                            address: "乌鲁木齐市天山区",
                            description: "入住酒店，享用欢迎晚宴，品尝新疆美食",
                            time: "晚间",
                            notes: "推荐魏家羊羔肉或胖老汉椒麻鸡"
                        }
                    ],
                    drivingDistance: "约30公里",
                    drivingTime: "1小时",
                    highlights: ["机场提车", "新疆美食初体验", "适应当地时差"]
                },
                {
                    day: 2,
                    date: "8月13日",
                    title: "乌鲁木齐 → 布尔津 - 五彩滩的落日熔金",
                    locations: [
                        {
                            name: "乌鲁木齐市区",
                            type: "departure",
                            coordinates: [87.617733, 43.792818],
                            address: "乌鲁木齐市",
                            description: "清晨出发，沿S21沙漠高速向北行驶",
                            time: "上午",
                            notes: "穿越古尔班通古特沙漠"
                        },
                        {
                            name: "布尔津县城",
                            type: "city",
                            coordinates: [86.8286, 47.7045],
                            address: "新疆阿勒泰地区布尔津县",
                            description: "抵达童话边城布尔津，办理酒店入住",
                            time: "下午",
                            notes: "稍作休整，准备前往五彩滩"
                        },
                        {
                            name: "五彩滩",
                            type: "attraction",
                            coordinates: [86.6833, 47.7667],
                            address: "布尔津县城西北约24公里",
                            description: "欣赏夕阳下的雅丹地貌，额尔齐斯河两岸对比强烈",
                            time: "傍晚",
                            notes: "建议新疆时间19:30-20:00抵达观日落"
                        },
                        {
                            name: "河堤夜市",
                            type: "restaurant",
                            coordinates: [86.8286, 47.7045],
                            address: "布尔津县城河堤",
                            description: "品尝额尔齐斯河冷水鱼烧烤和各种烤肉串",
                            time: "晚间",
                            notes: "布尔津特色美食体验"
                        },
                        {
                            name: "布尔津夜光城假日酒店",
                            type: "hotel",
                            coordinates: [86.8286, 47.7045],
                            address: "布尔津县",
                            description: "入住布尔津，为明日喀纳斯之行做准备",
                            time: "晚间",
                            notes: "高评价酒店选择"
                        }
                    ],
                    drivingDistance: "约650公里",
                    drivingTime: "7-8小时",
                    highlights: ["沙漠高速公路", "五彩滩日落", "冷水鱼美食"]
                },
                {
                    day: 3,
                    date: "8月14日",
                    title: "布尔津 → 喀纳斯国家公园 - 探访神的后花园",
                    locations: [
                        {
                            name: "贾登峪",
                            type: "transfer",
                            coordinates: [87.0167, 48.7167],
                            address: "喀纳斯国家公园门口",
                            description: "停车换乘，购买门票和区间车票",
                            time: "上午",
                            notes: "喀纳斯门票两日有效"
                        },
                        {
                            name: "神仙湾",
                            type: "attraction",
                            coordinates: [87.0333, 48.7333],
                            address: "喀纳斯景区内",
                            description: "喀纳斯三湾之一，晨雾缭绕如仙境",
                            time: "下午",
                            notes: "可徒步木栈道近距离观赏"
                        },
                        {
                            name: "月亮湾",
                            type: "attraction",
                            coordinates: [87.0417, 48.7417],
                            address: "喀纳斯景区内",
                            description: "形似弯月的湖湾，是喀纳斯的经典景观",
                            time: "下午",
                            notes: "最佳拍摄点之一"
                        },
                        {
                            name: "卧龙湾",
                            type: "attraction",
                            coordinates: [87.0500, 48.7500],
                            address: "喀纳斯景区内",
                            description: "湖中小岛形似卧龙，湖水清澈见底",
                            time: "下午",
                            notes: "三湾中最下游的一个"
                        },
                        {
                            name: "观鱼台",
                            type: "attraction",
                            coordinates: [87.0583, 48.7583],
                            address: "喀纳斯湖西岸山顶",
                            description: "从高处俯瞰喀纳斯湖全景，震撼之美",
                            time: "傍晚",
                            notes: "需换乘专线车，海拔2030米"
                        },
                        {
                            name: "喀纳斯花间坊民宿",
                            type: "hotel",
                            coordinates: [87.0417, 48.7417],
                            address: "喀纳斯景区内图瓦人村落",
                            description: "住在景区内，避开人潮，独享清晨宁静",
                            time: "晚间",
                            notes: "图瓦人特色住宿"
                        }
                    ],
                    drivingDistance: "约130公里",
                    drivingTime: "2.5-3小时",
                    highlights: ["喀纳斯三湾", "观鱼台全景", "图瓦人村落"]
                },
                {
                    day: 4,
                    date: "8月15日",
                    title: "喀纳斯 → 禾木村 - 童话般的村落",
                    locations: [
                        {
                            name: "喀纳斯湖",
                            type: "attraction",
                            coordinates: [87.0417, 48.7417],
                            address: "喀纳斯景区",
                            description: "晨光中享受湖泊静谧，可选择湖上游船",
                            time: "上午",
                            notes: "清晨是最佳观赏时间"
                        },
                        {
                            name: "禾木村",
                            type: "village",
                            coordinates: [87.1167, 48.6833],
                            address: "阿勒泰地区布尔津县禾木乡",
                            description: "中国最美村落之一，图瓦人聚居地",
                            time: "下午",
                            notes: "从贾登峪换乘专线巴士"
                        },
                        {
                            name: "禾木观景平台",
                            type: "viewpoint",
                            coordinates: [87.1200, 48.6800],
                            address: "禾木村对面山坡",
                            description: "拍摄禾木全景和日落炊烟的经典机位",
                            time: "傍晚",
                            notes: "徒步登山，田园诗画般美景"
                        },
                        {
                            name: "禾木云墅木屋",
                            type: "hotel",
                            coordinates: [87.1167, 48.6833],
                            address: "禾木村内",
                            description: "独具特色的图瓦小木屋住宿",
                            time: "晚间",
                            notes: "8月旺季价格较高，需提前预订"
                        }
                    ],
                    drivingDistance: "约60公里",
                    drivingTime: "2小时",
                    highlights: ["禾木村全景", "图瓦小木屋", "日落炊烟"]
                },
                {
                    day: 5,
                    date: "8月16日",
                    title: "禾木 → 乌尔禾 - 魔鬼城的日落魅影",
                    locations: [
                        {
                            name: "禾木观景平台",
                            type: "viewpoint",
                            coordinates: [87.1200, 48.6800],
                            address: "禾木村对面山坡",
                            description: "早起拍摄禾木晨雾，阳光穿透薄雾洒在木屋上",
                            time: "清晨",
                            notes: "约新疆时间6:00，如梦似幻"
                        },
                        {
                            name: "乌尔禾世界魔鬼城",
                            type: "attraction",
                            coordinates: [85.3167, 46.0833],
                            address: "克拉玛依市乌尔禾区",
                            description: "风蚀雅丹地貌群，乘小火车深入探索",
                            time: "傍晚",
                            notes: "日落时分最佳，光影诡谲神秘"
                        },
                        {
                            name: "乌尔禾镇",
                            type: "hotel",
                            coordinates: [85.3167, 46.0833],
                            address: "乌尔禾镇或克拉玛依市",
                            description: "住宿休息，为明日长途驾驶做准备",
                            time: "晚间",
                            notes: "地貌从森林过渡到荒漠戈壁"
                        }
                    ],
                    drivingDistance: "约350公里",
                    drivingTime: "5-6小时",
                    highlights: ["禾木晨雾", "地貌变化", "魔鬼城日落"]
                },
                {
                    day: 6,
                    date: "8月17日",
                    title: "乌尔禾 → 赛里木湖 → 伊宁 - 大西洋的最后一滴眼泪",
                    locations: [
                        {
                            name: "赛里木湖",
                            type: "attraction",
                            coordinates: [81.1500, 44.5833],
                            address: "博尔塔拉州博乐市",
                            description: "高原湖泊，纯净蓝色湖水配雪山背景",
                            time: "下午",
                            notes: "建议环湖一周约60公里"
                        },
                        {
                            name: "果子沟大桥",
                            type: "landmark",
                            coordinates: [81.2833, 44.3167],
                            address: "伊犁州霍城县",
                            description: "宏伟的现代桥梁工程，连接南北疆",
                            time: "傍晚",
                            notes: "途经地标性建筑"
                        },
                        {
                            name: "伊宁福朋喜来登酒店",
                            type: "hotel",
                            coordinates: [81.3167, 43.9167],
                            address: "伊宁市",
                            description: "伊犁河谷中心城市，酒店选择丰富",
                            time: "晚间",
                            notes: "国际连锁品牌酒店"
                        }
                    ],
                    drivingDistance: "约550公里",
                    drivingTime: "6-7小时",
                    highlights: ["赛里木湖环湖", "果子沟大桥", "伊犁河谷"]
                },
                {
                    day: 7,
                    date: "8月18日",
                    title: "伊宁 → 喀拉峻草原 → 特克斯 - 立体草原与八卦城",
                    locations: [
                        {
                            name: "喀拉峻草原",
                            type: "attraction",
                            coordinates: [81.8333, 43.0833],
                            address: "伊犁州特克斯县",
                            description: "人体草原，立体线条和壮阔视觉冲击",
                            time: "上午-下午",
                            notes: "乘区间车深入，摄影天堂"
                        },
                        {
                            name: "特克斯县城",
                            type: "city",
                            coordinates: [81.8333, 43.2167],
                            address: "伊犁州特克斯县",
                            description: "世界唯一八卦城，放射状街道布局",
                            time: "傍晚",
                            notes: "城内没有红绿灯的神奇县城"
                        }
                    ],
                    drivingDistance: "约200公里",
                    drivingTime: "4-5小时",
                    highlights: ["立体草原", "八卦城布局", "无红绿灯城市"]
                },
                {
                    day: 8,
                    date: "8月19日",
                    title: "特克斯 → 夏塔古道 → 昭苏 - 天山深处的秘境之路",
                    locations: [
                        {
                            name: "夏塔古道",
                            type: "attraction",
                            coordinates: [81.0167, 42.9833],
                            address: "伊犁州昭苏县夏塔乡",
                            description: "古丝绸之路上的重要通道，天山深处的绝美峡谷",
                            time: "上午-下午",
                            notes: "徒步体验古道风光，观赏夏塔河谷和雪山"
                        },
                        {
                            name: "昭苏草原",
                            type: "attraction",
                            coordinates: [81.1333, 43.1500],
                            address: "伊犁州昭苏县",
                            description: "中国最美的高山草甸之一，油菜花海（季节性）",
                            time: "下午",
                            notes: "8月正值油菜花盛开期"
                        },
                        {
                            name: "昭苏县城",
                            type: "hotel",
                            coordinates: [81.1333, 43.1500],
                            address: "昭苏县",
                            description: "入住昭苏县城，体验高原小城的宁静",
                            time: "晚间",
                            notes: "海拔较高，注意保暖"
                        }
                    ],
                    drivingDistance: "约180公里",
                    drivingTime: "3-4小时",
                    highlights: ["夏塔古道徒步", "昭苏油菜花海", "天山雪峰"]
                },
                {
                    day: 9,
                    date: "8月20日",
                    title: "昭苏 → 库车 - 穿越天山南北",
                    locations: [
                        {
                            name: "昭苏县城",
                            type: "departure",
                            coordinates: [81.1333, 43.1500],
                            address: "昭苏县",
                            description: "清晨出发，告别伊犁河谷",
                            time: "上午",
                            notes: "准备长途驾驶穿越天山"
                        },
                        {
                            name: "独库公路南段",
                            type: "road",
                            coordinates: [82.5000, 42.5000],
                            address: "G217国道南段",
                            description: "从伊犁方向进入独库公路，体验天山峡谷风光",
                            time: "全天",
                            notes: "一日游四季，十里不同天"
                        },
                        {
                            name: "库车县城",
                            type: "hotel",
                            coordinates: [82.9667, 41.7167],
                            address: "阿克苏地区库车县",
                            description: "抵达库车，古丝路重镇",
                            time: "晚间",
                            notes: "为明日独库公路北段做准备"
                        }
                    ],
                    drivingDistance: "约350公里",
                    drivingTime: "6-7小时",
                    highlights: ["独库公路南段", "天山峡谷", "古丝路重镇"]
                },
                {
                    day: 10,
                    date: "8月21日",
                    title: "库车 → 奎屯 - 驰骋传奇独库公路北段",
                    locations: [
                        {
                            name: "库车大峡谷",
                            type: "attraction",
                            coordinates: [83.0000, 41.7000],
                            address: "库车县城附近",
                            description: "天山神秘大峡谷，红色砂岩峡谷奇观",
                            time: "上午",
                            notes: "可选景点，时间充裕可游览"
                        },
                        {
                            name: "独库公路北段",
                            type: "road",
                            coordinates: [83.5000, 42.5000],
                            address: "G217国道北段",
                            description: "继续穿越独库公路最精华的北段",
                            time: "全天",
                            notes: "通行时间北京时间9:00-20:00"
                        },
                        {
                            name: "大小龙池",
                            type: "attraction",
                            coordinates: [84.4167, 43.0833],
                            address: "独库公路沿线",
                            description: "高山湖泊，途经冰川雪岭",
                            time: "途中",
                            notes: "一日游四季，十里不同天"
                        },
                        {
                            name: "独山子",
                            type: "city",
                            coordinates: [84.8833, 44.3167],
                            address: "克拉玛依市独山子区",
                            description: "独库公路北端终点",
                            time: "傍晚",
                            notes: "驶出独库公路"
                        },
                        {
                            name: "奎屯上东湖大酒店",
                            type: "hotel",
                            coordinates: [84.9000, 44.4167],
                            address: "奎屯市",
                            description: "重要交通枢纽，住宿选择良好",
                            time: "晚间",
                            notes: "为返程做准备"
                        }
                    ],
                    drivingDistance: "约380公里",
                    drivingTime: "7-8小时",
                    highlights: ["库车大峡谷", "独库公路北段", "大小龙池", "四季变换"]
                },
                {
                    day: 11,
                    date: "8月22日",
                    title: "奎屯 → 乌鲁木齐 → 早班机返程 - 北疆之旅的完美句号",
                    locations: [
                        {
                            name: "奎屯市区",
                            type: "departure",
                            coordinates: [84.9000, 44.4167],
                            address: "奎屯市",
                            description: "清晨出发前往乌鲁木齐，为早班机做准备",
                            time: "清晨",
                            notes: "约凌晨4:00出发，确保及时到达机场"
                        },
                        {
                            name: "国际大巴扎（可选）",
                            type: "shopping",
                            coordinates: [87.6167, 43.8000],
                            address: "乌鲁木齐市天山区",
                            description: "时间充裕可快速采购特产纪念品",
                            time: "早上",
                            notes: "根据时间安排，可选择性购买"
                        },
                        {
                            name: "乌鲁木齐地窝堡国际机场",
                            type: "airport",
                            coordinates: [87.474411, 43.907105],
                            address: "新疆维吾尔自治区乌鲁木齐市新市区",
                            description: "办理还车手续，搭乘06:35航班返回温州",
                            time: "早上",
                            notes: "06:35航班，需04:00左右到达机场办理手续"
                        }
                    ],
                    drivingDistance: "约280公里",
                    drivingTime: "约3.5小时",
                    highlights: ["早班机返程", "11日北疆完美收官", "满载回忆归途"]
                }
            ]
        };

        // 错误处理和用户反馈
        function showError(title, message, isRetryable = false) {
            const errorHtml = `
                <div class="flex items-center justify-center h-full bg-red-50">
                    <div class="text-center p-8 max-w-md">
                        <div class="text-6xl mb-4">❌</div>
                        <h2 class="text-2xl font-bold text-red-700 mb-4">${title}</h2>
                        <p class="text-red-600 mb-4">${message}</p>
                        ${isRetryable ? `
                            <button onclick="location.reload()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                重新加载
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            document.getElementById('map-container').innerHTML = errorHtml;
        }

        function showApiKeySetup() {
            const setupHtml = `
                <div class="flex items-center justify-center h-full bg-gray-50">
                    <div class="text-center p-8 max-w-lg">
                        <div class="text-6xl mb-4">🗺️</div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">需要配置高德地图API密钥</h2>
                        <div class="text-left bg-white p-6 rounded-lg shadow-lg mb-6">
                            <h3 class="text-lg font-semibold mb-3">配置步骤：</h3>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-600">
                                <li>访问 <a href="https://console.amap.com/" target="_blank" class="text-blue-500 hover:underline">高德开放平台</a></li>
                                <li>注册并登录账号</li>
                                <li>创建新应用，选择"Web端(JS API)"</li>
                                <li>获取API密钥(Key)</li>
                                <li>在代码中替换 <code class="bg-gray-100 px-2 py-1 rounded">GAODE_API_KEY</code> 的值</li>
                                <li class="text-red-600 font-medium">重要：在高德控制台中设置域名白名单，包括 localhost 和您的域名</li>
                            </ol>
                        </div>
                        <div class="text-sm text-gray-500">
                            <p class="mb-2">当前API密钥状态：<span class="text-red-500 font-medium">未配置</span></p>
                            <p>配置完成后刷新页面即可使用</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('map-container').innerHTML = setupHtml;
        }

        // 验证API密钥格式
        function validateApiKey(key) {
            // 高德地图API密钥通常是32位字符串
            return key && key.length >= 20 && key !== "在此处输入您的高德地图API密钥";
        }

        // 测试API密钥有效性
        function testApiKey() {
            console.log('开始测试API密钥...');

            // 创建一个简单的测试请求
            const testUrl = `https://restapi.amap.com/v3/ip?key=${GAODE_API_KEY}`;

            fetch(testUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('API测试响应:', data);
                    if (data.status === '1') {
                        alert('API密钥有效！问题可能是网络连接或其他原因。请检查浏览器控制台获取更多信息。');
                    } else {
                        alert(`API密钥测试失败: ${data.info || '未知错误'}`);
                    }
                })
                .catch(error => {
                    console.error('API测试失败:', error);
                    alert('API测试请求失败，可能是网络连接问题或CORS限制。');
                });
        }

        // 应用初始化
        document.addEventListener('DOMContentLoaded', function () {
            try {
                // 检查API密钥
                if (!validateApiKey(GAODE_API_KEY)) {
                    showApiKeySetup();
                    return;
                }

                // 加载地图API并初始化应用
                loadGaodeMapAPI().then(() => {
                    console.log('高德地图API加载成功');

                    // 初始化地图
                    initializeMap();

                    // 初始化侧边栏
                    renderItinerarySidebar();

                    // 添加控制按钮事件监听器
                    setupControlButtons();

                    // 初始化统计图表
                    setupStatistics();

                    // 设置键盘快捷键
                    setupKeyboardShortcuts();

                    // 设置无障碍功能
                    setupAccessibility();

                    // 显示成功提示
                    console.log('🎉 新疆旅行地图应用加载完成！');
                    console.log('💡 提示：点击侧边栏的天数查看每日行程，使用数字键1-9快速切换');

                }).catch((error) => {
                    console.error('高德地图API加载失败:', error);

                    // 详细的错误诊断
                    let errorMessage = '请检查网络连接和API密钥配置';
                    let diagnosticInfo = '';

                    if (error.message && error.message.includes('key')) {
                        errorMessage = 'API密钥无效或已过期，请检查密钥配置';
                        diagnosticInfo = `当前API密钥: ${GAODE_API_KEY.substring(0, 8)}...`;
                    } else if (error.message && error.message.includes('network')) {
                        errorMessage = '网络连接失败，请检查网络设置';
                        diagnosticInfo = '无法连接到高德地图服务器';
                    } else {
                        // 检查是否是CORS或其他网络问题
                        diagnosticInfo = `错误详情: ${error.message || '未知错误'}`;
                    }

                    // 显示详细的错误信息
                    const detailedErrorHtml = `
                        <div class="flex items-center justify-center h-full bg-red-50">
                            <div class="text-center p-8 max-w-lg">
                                <div class="text-6xl mb-4">❌</div>
                                <h2 class="text-2xl font-bold text-red-700 mb-4">地图加载失败</h2>
                                <p class="text-red-600 mb-4">${errorMessage}</p>
                                <div class="bg-white p-4 rounded-lg shadow-lg mb-4 text-left">
                                    <h3 class="font-semibold mb-2">诊断信息：</h3>
                                    <p class="text-sm text-gray-600 mb-2">${diagnosticInfo}</p>
                                    <p class="text-sm text-gray-600 mb-2">API密钥长度: ${GAODE_API_KEY.length} 字符</p>
                                    <p class="text-sm text-gray-600">请求URL: https://webapi.amap.com/maps?v=2.0&key=${GAODE_API_KEY.substring(0, 8)}...</p>
                                </div>
                                <div class="space-y-2">
                                    <button onclick="location.reload()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors mr-2">
                                        重新加载
                                    </button>
                                    <button onclick="testApiKey()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors mr-2">
                                        测试API密钥
                                    </button>
                                    <button onclick="window.open('api-test.html', '_blank')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        打开诊断工具
                                    </button>
                                </div>
                                <div class="mt-4 text-sm text-gray-600">
                                    <p><strong>常见解决方案：</strong></p>
                                    <ul class="list-disc list-inside mt-2 space-y-1">
                                        <li>在高德控制台添加域名白名单（包括localhost）</li>
                                        <li>确保启用了JavaScript API v2.0服务</li>
                                        <li>检查网络连接和防火墙设置</li>
                                        <li>尝试使用HTTPS协议访问</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('map-container').innerHTML = detailedErrorHtml;
                });

            } catch (error) {
                console.error('应用初始化失败:', error);
                showError('应用初始化失败', '发生未知错误，请刷新页面重试', true);
            }
        });

        // 渲染侧边栏行程列表
        function renderItinerarySidebar() {
            const container = document.getElementById('itinerary-list');
            let html = '';

            itineraryData.days.forEach(day => {
                html += `
                    <div class="day-item mb-6 p-4 bg-gray-50 rounded-lg hover:bg-blue-50 cursor-pointer transition-colors" data-day="${day.day}">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-800">第${day.day}天 - ${day.date}</h3>
                            <span class="text-sm text-blue-600">${day.drivingDistance}</span>
                        </div>
                        <h4 class="text-md font-medium text-gray-700 mb-3">${day.title}</h4>
                        
                        <div class="space-y-2">
                            ${day.locations.map(location => `
                                <div class="location-item flex items-start space-x-3 p-2 rounded hover:bg-white transition-colors" data-location="${location.name}">
                                    <div class="location-icon mt-1">
                                        ${getLocationIcon(location.type)}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium text-gray-800">${location.name}</span>
                                            <span class="text-xs text-gray-500">${location.time}</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1">${location.description}</p>
                                        ${location.notes ? `<p class="text-xs text-blue-600 mt-1">${location.notes}</p>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex flex-wrap gap-2">
                                ${day.highlights.map(highlight => `
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">${highlight}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // 添加点击事件监听器
            container.addEventListener('click', function (e) {
                const dayItem = e.target.closest('.day-item');
                const locationItem = e.target.closest('.location-item');

                if (locationItem && !dayItem.classList.contains('bg-blue-100')) {
                    // 点击地点项，高亮对应的地图标记
                    const locationName = locationItem.dataset.location;
                    highlightLocationOnMap(locationName);
                    e.stopPropagation(); // 阻止事件冒泡到day-item
                } else if (dayItem) {
                    // 点击天数项，选择该天
                    const dayNumber = parseInt(dayItem.dataset.day);
                    selectDay(dayNumber);
                }
            });

            // 添加鼠标悬停事件监听器
            container.addEventListener('mouseover', function (e) {
                const locationItem = e.target.closest('.location-item');
                if (locationItem) {
                    const locationName = locationItem.dataset.location;
                    highlightLocationOnMap(locationName, true); // true表示只是悬停高亮
                    locationItem.classList.add('bg-blue-50');
                }
            });

            container.addEventListener('mouseout', function (e) {
                const locationItem = e.target.closest('.location-item');
                if (locationItem) {
                    locationItem.classList.remove('bg-blue-50');
                    // 如果不是当前选中的天数，清除地图高亮
                    const dayItem = locationItem.closest('.day-item');
                    if (!dayItem.classList.contains('bg-blue-100')) {
                        clearMapHighlight();
                    }
                }
            });
        }

        // 获取地点类型对应的图标
        function getLocationIcon(type) {
            const icons = {
                'airport': '✈️',
                'hotel': '🏨',
                'attraction': '🏞️',
                'restaurant': '🍽️',
                'city': '🏙️',
                'village': '🏘️',
                'viewpoint': '📸',
                'transfer': '🚌',
                'departure': '🚗',
                'road': '🛣️',
                'landmark': '🌉',
                'shopping': '🛍️'
            };
            return icons[type] || '📍';
        }

        // 全局变量
        let map = null;
        let mapController = null;
        let currentDay = null;

        // MapController类 - 管理所有地图操作
        class MapController {
            constructor(containerId) {
                this.map = null;
                this.markers = [];
                this.routes = [];
                this.driving = null;
                this.infoWindows = [];
                this.containerId = containerId;
                this.init();
            }

            // 初始化地图
            init() {
                try {
                    // 创建地图实例
                    this.map = new AMap.Map(this.containerId, {
                        zoom: 5.5,
                        center: [87.0, 44.5], // 新疆北部中心位置
                        mapStyle: 'amap://styles/normal',
                        viewMode: '2D',
                        pitch: 0,
                        rotation: 0,
                        showLabel: true,
                        features: ['bg', 'road', 'building', 'point'],
                        zooms: [3, 18] // 设置缩放范围
                    });

                    // 添加地图控件
                    try {
                        // 比例尺控件
                        if (AMap.Scale) {
                            this.map.addControl(new AMap.Scale());
                        }

                        // 工具条控件
                        if (AMap.ToolBar) {
                            this.map.addControl(new AMap.ToolBar({
                                position: {
                                    top: '10px',
                                    left: '10px'
                                }
                            }));
                        }
                    } catch (error) {
                        console.warn('地图控件初始化失败:', error);
                        // 控件失败不影响核心功能，继续执行
                    }

                    // 初始化驾车路线规划服务
                    this.driving = new AMap.Driving({
                        map: this.map,
                        showTraffic: false,
                        hideMarkers: true // 隐藏默认的起终点标记
                    });

                    // 地图加载完成事件
                    this.map.on('complete', () => {
                        console.log('地图初始化完成');
                        // 延迟显示所有天数，确保地图完全加载
                        setTimeout(() => {
                            this.displayAllDays();
                        }, 300);
                    });

                    console.log('MapController初始化成功');
                } catch (error) {
                    console.error('地图初始化失败:', error);
                    this.showError('地图初始化失败', '请检查API密钥是否正确配置');
                }
            }

            // 显示错误信息
            showError(title, message) {
                document.getElementById(this.containerId).innerHTML = `
                    <div class="flex items-center justify-center h-full bg-red-50">
                        <div class="text-center p-8">
                            <div class="text-6xl mb-4">❌</div>
                            <h2 class="text-2xl font-bold text-red-700 mb-4">${title}</h2>
                            <p class="text-red-600">${message}</p>
                        </div>
                    </div>
                `;
            }

            // 清除所有覆盖物
            clearOverlays() {
                try {
                    // 清除标记点
                    this.markers.forEach(marker => {
                        if (marker && this.map) {
                            // 移除事件监听器
                            marker.clearEvents();
                            this.map.remove(marker);
                        }
                    });
                    this.markers = [];

                    // 清除路线
                    this.routes.forEach(route => {
                        if (route && this.map) {
                            this.map.remove(route);
                        }
                    });
                    this.routes = [];

                    // 清除信息窗
                    this.infoWindows.forEach(infoWindow => {
                        if (infoWindow) {
                            infoWindow.close();
                        }
                    });
                    this.infoWindows = [];

                    // 清除驾车路线
                    if (this.driving) {
                        this.driving.clear();
                    }
                } catch (error) {
                    console.warn('清除覆盖物时发生错误:', error);
                }
            }

            // 销毁MapController实例
            destroy() {
                this.clearOverlays();
                if (this.map) {
                    this.map.destroy();
                    this.map = null;
                }
                this.driving = null;
            }

            // 添加标记点
            addMarker(location, dayNumber) {
                if (!location.coordinates || location.coordinates.length !== 2) {
                    console.warn('地点坐标无效:', location.name);
                    return null;
                }

                const [lng, lat] = location.coordinates;

                // 根据地点类型选择图标
                const iconConfig = this.getMarkerIcon(location.type);

                const marker = new AMap.Marker({
                    position: new AMap.LngLat(lng, lat),
                    title: location.name,
                    icon: new AMap.Icon({
                        image: iconConfig.image,
                        size: new AMap.Size(iconConfig.size, iconConfig.size),
                        imageSize: new AMap.Size(iconConfig.size, iconConfig.size)
                    }),
                    offset: new AMap.Pixel(-iconConfig.size / 2, -iconConfig.size),
                    extData: {
                        location: location,
                        day: dayNumber
                    }
                });

                // 添加点击事件
                marker.on('click', (e) => {
                    this.showInfoWindow(marker, location);
                });

                // 添加到地图
                this.map.add(marker);
                this.markers.push(marker);

                return marker;
            }

            // 获取标记点图标配置
            getMarkerIcon(type) {
                const iconConfigs = {
                    'airport': { color: '#FF6B6B', emoji: '✈️', size: 32 },
                    'hotel': { color: '#4ECDC4', emoji: '🏨', size: 28 },
                    'attraction': { color: '#45B7D1', emoji: '🏞️', size: 30 },
                    'restaurant': { color: '#FFA07A', emoji: '🍽️', size: 26 },
                    'city': { color: '#98D8C8', emoji: '🏙️', size: 28 },
                    'village': { color: '#F7DC6F', emoji: '🏘️', size: 26 },
                    'viewpoint': { color: '#BB8FCE', emoji: '📸', size: 28 },
                    'transfer': { color: '#85C1E9', emoji: '🚌', size: 24 },
                    'departure': { color: '#82E0AA', emoji: '🚗', size: 26 },
                    'road': { color: '#F8C471', emoji: '🛣️', size: 24 },
                    'landmark': { color: '#D7BDE2', emoji: '🌉', size: 30 },
                    'shopping': { color: '#F9E79F', emoji: '🛍️', size: 26 }
                };

                const config = iconConfigs[type] || { color: '#95A5A6', emoji: '📍', size: 24 };

                // 创建带emoji的SVG图标
                const svg = `
                    <svg width="${config.size}" height="${config.size + 8}" viewBox="0 0 ${config.size} ${config.size + 8}" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.3)"/>
                            </filter>
                        </defs>
                        <circle cx="${config.size / 2}" cy="${config.size / 2}" r="${config.size / 2 - 2}" fill="${config.color}" stroke="white" stroke-width="2" filter="url(#shadow)"/>
                        <text x="${config.size / 2}" y="${config.size / 2 + 4}" text-anchor="middle" font-size="${config.size * 0.4}" fill="white">${config.emoji}</text>
                        <path d="M${config.size / 2} ${config.size} L${config.size / 2 - 4} ${config.size - 8} L${config.size / 2 + 4} ${config.size - 8} Z" fill="${config.color}" stroke="white" stroke-width="1"/>
                    </svg>
                `;

                return {
                    image: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg))),
                    size: config.size
                };
            }

            // 显示信息窗
            showInfoWindow(marker, location) {
                // 关闭其他信息窗
                this.infoWindows.forEach(infoWindow => {
                    infoWindow.close();
                });

                // 获取地点类型的emoji
                const typeEmoji = this.getLocationTypeEmoji(location.type);

                const content = `
                    <div class="p-4 max-w-sm bg-white rounded-lg shadow-lg">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">${typeEmoji}</span>
                            <h3 class="text-lg font-bold text-gray-800">${location.name}</h3>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-start">
                                <span class="font-medium text-gray-600 mr-2 min-w-12">📍</span>
                                <span class="text-gray-700">${location.address}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-medium text-gray-600 mr-2 min-w-12">⏰</span>
                                <span class="text-gray-700">${location.time}</span>
                            </div>
                            <div class="flex items-start">
                                <span class="font-medium text-gray-600 mr-2 min-w-12">📝</span>
                                <span class="text-gray-700">${location.description}</span>
                            </div>
                            ${location.notes ? `
                                <div class="mt-3 p-2 bg-blue-50 border-l-4 border-blue-400 rounded">
                                    <div class="flex items-start">
                                        <span class="text-blue-600 mr-2">💡</span>
                                        <span class="text-blue-800 text-sm">${location.notes}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                const infoWindow = new AMap.InfoWindow({
                    content: content,
                    offset: new AMap.Pixel(0, -40),
                    closeWhenClickMap: true,
                    autoMove: true
                });

                infoWindow.open(this.map, marker.getPosition());
                this.infoWindows.push(infoWindow);
            }

            // 获取地点类型对应的emoji
            getLocationTypeEmoji(type) {
                const emojis = {
                    'airport': '✈️',
                    'hotel': '🏨',
                    'attraction': '🏞️',
                    'restaurant': '🍽️',
                    'city': '🏙️',
                    'village': '🏘️',
                    'viewpoint': '📸',
                    'transfer': '🚌',
                    'departure': '🚗',
                    'road': '🛣️',
                    'landmark': '🌉',
                    'shopping': '🛍️'
                };
                return emojis[type] || '📍';
            }

            // 获取高亮标记图标配置
            getHighlightMarkerIcon(type) {
                const iconConfigs = {
                    'airport': { color: '#FF4444', emoji: '✈️', size: 36 },
                    'hotel': { color: '#22CCAA', emoji: '🏨', size: 32 },
                    'attraction': { color: '#2288DD', emoji: '🏞️', size: 34 },
                    'restaurant': { color: '#FF8844', emoji: '🍽️', size: 30 },
                    'city': { color: '#66DD99', emoji: '🏙️', size: 32 },
                    'village': { color: '#DDCC44', emoji: '🏘️', size: 30 },
                    'viewpoint': { color: '#AA66DD', emoji: '📸', size: 32 },
                    'transfer': { color: '#5599EE', emoji: '🚌', size: 28 },
                    'departure': { color: '#55DD77', emoji: '🚗', size: 30 },
                    'road': { color: '#DD9944', emoji: '🛣️', size: 28 },
                    'landmark': { color: '#BB77DD', emoji: '🌉', size: 34 },
                    'shopping': { color: '#DDDD44', emoji: '🛍️', size: 30 }
                };

                const config = iconConfigs[type] || { color: '#666666', emoji: '📍', size: 28 };

                // 创建高亮的SVG图标（更大、更亮）
                const svg = `
                    <svg width="${config.size}" height="${config.size + 8}" viewBox="0 0 ${config.size} ${config.size + 8}" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge> 
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0" dy="3" stdDeviation="3" flood-color="rgba(0,0,0,0.4)"/>
                            </filter>
                        </defs>
                        <circle cx="${config.size / 2}" cy="${config.size / 2}" r="${config.size / 2 - 2}" fill="${config.color}" stroke="white" stroke-width="3" filter="url(#shadow) url(#glow)"/>
                        <text x="${config.size / 2}" y="${config.size / 2 + 4}" text-anchor="middle" font-size="${config.size * 0.4}" fill="white">${config.emoji}</text>
                        <path d="M${config.size / 2} ${config.size} L${config.size / 2 - 5} ${config.size - 10} L${config.size / 2 + 5} ${config.size - 10} Z" fill="${config.color}" stroke="white" stroke-width="2"/>
                    </svg>
                `;

                return {
                    image: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg))),
                    size: config.size
                };
            }

            // 显示所有天数的行程
            displayAllDays() {
                this.clearOverlays();

                // 添加所有地点的标记
                itineraryData.days.forEach(day => {
                    day.locations.forEach(location => {
                        this.addMarker(location, day.day);
                    });
                });

                // 显示主要路线连接
                this.displayAllDaysRoutes();

                // 设置地图视野包含所有标记点
                this.fitViewToAllMarkers();
            }

            // 显示特定天数的行程
            displayDay(dayNumber) {
                // 显示加载状态
                this.showLoadingState(`正在加载第${dayNumber}天行程...`);

                // 使用setTimeout确保UI更新
                setTimeout(() => {
                    try {
                        this.clearOverlays();

                        const dayData = itineraryData.days.find(day => day.day === dayNumber);
                        if (!dayData) {
                            console.error('未找到第', dayNumber, '天的数据');
                            this.hideLoadingState();
                            return;
                        }

                        // 添加当天的标记点
                        const dayMarkers = [];
                        dayData.locations.forEach(location => {
                            const marker = this.addMarker(location, dayNumber);
                            if (marker) {
                                dayMarkers.push(marker);
                            }
                        });

                        // 计算并显示当天的驾驶路线
                        this.calculateDayRoute(dayData, dayNumber);

                        // 设置地图视野包含当天的标记点
                        this.fitViewToMarkers(dayMarkers);

                        console.log(`显示第${dayNumber}天行程:`, dayData.title);

                        // 隐藏加载状态
                        setTimeout(() => this.hideLoadingState(), 1000);

                    } catch (error) {
                        console.error('显示天数行程时发生错误:', error);
                        this.hideLoadingState();
                    }
                }, 100);
            }

            // 显示加载状态
            showLoadingState(message = '加载中...') {
                const loadingDiv = document.getElementById('loading-overlay') || this.createLoadingOverlay();
                loadingDiv.querySelector('.loading-message').textContent = message;
                loadingDiv.classList.remove('hidden');
            }

            // 隐藏加载状态
            hideLoadingState() {
                const loadingDiv = document.getElementById('loading-overlay');
                if (loadingDiv) {
                    loadingDiv.classList.add('hidden');
                }
            }

            // 创建加载覆盖层
            createLoadingOverlay() {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-overlay';
                loadingDiv.className = 'absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden';
                loadingDiv.innerHTML = `
                    <div class="text-center">
                        <div class="loading-spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <div class="loading-message text-gray-600">加载中...</div>
                    </div>
                `;
                document.getElementById('map-container').appendChild(loadingDiv);
                return loadingDiv;
            }



            // 调整地图视野以包含指定的标记点（带动画）
            fitViewToMarkers(markers) {
                if (!markers || markers.length === 0) return;

                if (markers.length === 1) {
                    // 如果只有一个标记点，平滑居中显示
                    this.map.setCenter(markers[0].getPosition(), true);
                    this.map.setZoom(10, true);
                } else {
                    // 多个标记点，平滑调整视野包含所有点
                    const bounds = new AMap.Bounds();
                    markers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    this.map.setBounds(bounds, true, [120, 120, 120, 120]);

                    // 确保缩放级别合理
                    setTimeout(() => {
                        const currentZoom = this.map.getZoom();
                        if (currentZoom < 6) {
                            this.map.setZoom(7, true);
                        } else if (currentZoom > 12) {
                            this.map.setZoom(10, true);
                        }
                    }, 500);
                }
            }

            // 平滑调整地图视野以包含所有标记点
            fitViewToAllMarkers() {
                if (this.markers.length === 0) {
                    // 如果没有标记点，设置默认的新疆北部视野
                    this.setOptimalXinjiangView();
                    return;
                }

                const bounds = new AMap.Bounds();
                this.markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });

                // 使用动画效果，并设置合适的边距
                this.map.setBounds(bounds, true, [60, 60, 60, 60]);

                // 确保缩放级别在合理范围内
                setTimeout(() => {
                    const currentZoom = this.map.getZoom();
                    if (currentZoom < 4.5) {
                        this.map.setZoom(5, true);
                    } else if (currentZoom > 8) {
                        this.map.setZoom(7, true);
                    }
                }, 800);
            }

            // 设置最佳的新疆视野
            setOptimalXinjiangView() {
                // 新疆北部旅游区域的最佳视野
                const xinjiangBounds = new AMap.Bounds(
                    new AMap.LngLat(80.0, 40.0), // 西南角
                    new AMap.LngLat(95.0, 49.0)  // 东北角
                );

                this.map.setBounds(xinjiangBounds, true, [40, 40, 40, 40]);

                // 确保缩放级别合适
                setTimeout(() => {
                    const currentZoom = this.map.getZoom();
                    if (currentZoom < 5) {
                        this.map.setZoom(5.5, true);
                    }
                }, 500);
            }

            // 计算并显示当天的驾驶路线
            calculateDayRoute(dayData, dayNumber) {
                // 过滤出有效坐标的地点
                const validLocations = dayData.locations.filter(location =>
                    location.coordinates && location.coordinates.length === 2
                );

                if (validLocations.length < 2) {
                    console.log(`第${dayNumber}天地点不足，无法计算路线`);
                    return;
                }

                // 获取路线颜色
                const routeColor = this.getDayRouteColor(dayNumber);

                // 创建路线点数组
                const waypoints = validLocations.map(location =>
                    new AMap.LngLat(location.coordinates[0], location.coordinates[1])
                );

                // 对于新疆的长距离路线，直接使用直线连接更稳定
                console.log(`第${dayNumber}天：显示路线连接（${waypoints.length}个地点）`);
                this.drawStraightLine(waypoints, routeColor, dayNumber);
            }

            // 获取每天路线的颜色
            getDayRouteColor(dayNumber) {
                const colors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                    '#F7DC6F', '#BB8FCE', '#85C1E9', '#82E0AA', '#F8C471',
                    '#D7BDE2', '#F9E79F'
                ];
                return colors[(dayNumber - 1) % colors.length];
            }

            // 计算多点路线
            calculateMultiPointRoute(waypoints, color, dayNumber) {
                let completedSegments = 0;
                const totalSegments = waypoints.length - 1;
                let failedSegments = 0;

                for (let i = 0; i < waypoints.length - 1; i++) {
                    const start = waypoints[i];
                    const end = waypoints[i + 1];

                    // 创建新的驾驶路线实例用于每段路线
                    const segmentDriving = new AMap.Driving({
                        map: this.map,
                        showTraffic: false,
                        hideMarkers: true,
                        polyOptions: {
                            strokeColor: color,
                            strokeWeight: 4,
                            strokeOpacity: 0.8
                        }
                    });

                    // 添加超时处理
                    const timeoutId = setTimeout(() => {
                        console.warn(`第${dayNumber}天路线段 ${i + 1} 计算超时，使用直线连接`);
                        this.drawStraightLine([start, end], color, dayNumber);
                        failedSegments++;
                    }, 10000); // 10秒超时

                    segmentDriving.search(start, end, [], (status, result) => {
                        clearTimeout(timeoutId);
                        completedSegments++;

                        if (status === 'complete') {
                            // 路线计算成功
                            console.log(`第${dayNumber}天路线段 ${i + 1}/${totalSegments} 计算完成`);
                        } else {
                            // 路线计算失败，绘制直线
                            console.warn(`第${dayNumber}天路线段 ${i + 1} 计算失败 (${status})，使用直线连接`);
                            this.drawStraightLine([start, end], color, dayNumber);
                            failedSegments++;
                        }

                        // 所有路线段都处理完成
                        if (completedSegments === totalSegments) {
                            if (failedSegments > 0) {
                                console.warn(`第${dayNumber}天路线计算完成，其中${failedSegments}段使用直线连接`);
                            } else {
                                console.log(`第${dayNumber}天所有路线段计算完成`);
                            }
                        }
                    });
                }
            }

            // 绘制路线连接
            drawStraightLine(waypoints, color, dayNumber) {
                if (waypoints.length < 2) return;

                const polyline = new AMap.Polyline({
                    path: waypoints,
                    strokeColor: color,
                    strokeWeight: 3,
                    strokeOpacity: 0.7,
                    strokeStyle: 'solid',
                    lineJoin: 'round',
                    lineCap: 'round',
                    extData: {
                        day: dayNumber,
                        type: 'route-line'
                    }
                });

                this.map.add(polyline);
                this.routes.push(polyline);

                // 计算总距离（直线距离）
                let totalDistance = 0;
                for (let i = 0; i < waypoints.length - 1; i++) {
                    const distance = waypoints[i].distance(waypoints[i + 1]);
                    totalDistance += distance;
                }

                console.log(`第${dayNumber}天路线：${waypoints.length}个地点，直线距离约${(totalDistance / 1000).toFixed(0)}公里`);
            }

            // 自定义路线样式
            customizeRouteStyle(result, color, dayNumber) {
                if (result.routes && result.routes.length > 0) {
                    const route = result.routes[0];
                    // 这里可以进一步自定义路线样式
                    console.log(`第${dayNumber}天路线长度: ${(route.distance / 1000).toFixed(1)}公里`);
                }
            }

            // 显示所有天数的路线（简化版）
            displayAllDaysRoutes() {
                // 为了性能考虑，显示所有天数时不显示详细路线
                // 只显示主要的连接线
                const mainPoints = [];

                itineraryData.days.forEach(day => {
                    // 取每天的第一个和最后一个有效地点
                    const validLocations = day.locations.filter(location =>
                        location.coordinates && location.coordinates.length === 2
                    );

                    if (validLocations.length > 0) {
                        mainPoints.push({
                            point: new AMap.LngLat(validLocations[0].coordinates[0], validLocations[0].coordinates[1]),
                            day: day.day
                        });

                        if (validLocations.length > 1) {
                            const lastLocation = validLocations[validLocations.length - 1];
                            mainPoints.push({
                                point: new AMap.LngLat(lastLocation.coordinates[0], lastLocation.coordinates[1]),
                                day: day.day
                            });
                        }
                    }
                });

                // 绘制主要路线连接
                if (mainPoints.length > 1) {
                    const mainRoute = new AMap.Polyline({
                        path: mainPoints.map(p => p.point),
                        strokeColor: '#666666',
                        strokeWeight: 3,
                        strokeOpacity: 0.6,
                        strokeStyle: 'solid'
                    });

                    this.map.add(mainRoute);
                    this.routes.push(mainRoute);
                }
            }

            // 高亮特定标记点
            highlightMarker(locationName) {
                const marker = this.markers.find(m =>
                    m.getExtData().location.name === locationName
                );

                if (marker) {
                    // 居中到标记点
                    this.map.setCenter(marker.getPosition());
                    // 显示信息窗
                    this.showInfoWindow(marker, marker.getExtData().location);
                }
            }
        }

        // 初始化高德地图
        function initializeMap() {
            mapController = new MapController('map-container');
            map = mapController.map; // 保持向后兼容

            // 添加控制按钮事件监听器
            setupControlButtons();

            // 初始化统计图表
            setupStatistics();
        }

        // 显示所有天数的行程
        function showAllDays() {
            if (!mapController) return;

            // 重置当前选中的天数
            currentDay = null;

            // 移除所有天数的选中状态
            document.querySelectorAll('.day-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'border-blue-300');
                item.classList.add('bg-gray-50');
            });

            // 隐藏当前天数信息
            document.getElementById('current-day-info').classList.add('hidden');

            // 使用MapController显示所有天数
            mapController.displayAllDays();

            console.log('显示全部行程');
        }

        // 设置控制按钮事件监听器
        function setupControlButtons() {
            // 显示全部行程按钮
            document.getElementById('show-all-days').addEventListener('click', function () {
                showAllDays();
            });

            // 快速导航按钮
            document.getElementById('quick-nav-all').addEventListener('click', function () {
                showAllDays();
            });

            document.getElementById('quick-nav-attractions').addEventListener('click', function () {
                showMainAttractions();
            });

            // 地图样式切换按钮
            let issatellite = false;
            document.getElementById('map-style-toggle').addEventListener('click', function () {
                if (mapController && mapController.map) {
                    if (issatellite) {
                        mapController.map.setMapStyle('amap://styles/normal');
                        this.textContent = '卫星地图';
                        issatellite = false;
                    } else {
                        mapController.map.setMapStyle('amap://styles/satellite');
                        this.textContent = '标准地图';
                        issatellite = true;
                    }
                }
            });

            // 重置视野按钮
            document.getElementById('reset-view').addEventListener('click', function () {
                if (mapController) {
                    console.log('重置地图视野到新疆北部区域');
                    mapController.setOptimalXinjiangView();
                }
            });

            // 移动端侧边栏切换
            setupMobileSidebar();
        }

        // 设置移动端侧边栏功能
        function setupMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mobileToggle = document.getElementById('mobile-sidebar-toggle');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mainContainer = document.getElementById('main-container');

            // 检查是否为移动设备
            function isMobile() {
                return window.innerWidth <= 768;
            }

            // 检查是否为触摸设备
            function isTouchDevice() {
                return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            }

            // 切换侧边栏显示
            function toggleSidebar() {
                if (isMobile()) {
                    sidebar.classList.toggle('sidebar-collapsed');
                }
            }

            // 移动端显示侧边栏按钮
            mobileToggle.addEventListener('click', function (e) {
                e.preventDefault();
                if (isMobile()) {
                    sidebar.classList.remove('sidebar-collapsed');
                }
            });

            // 侧边栏关闭按钮
            sidebarToggle.addEventListener('click', function (e) {
                e.preventDefault();
                if (isMobile()) {
                    sidebar.classList.add('sidebar-collapsed');
                }
            });

            // 触摸手势支持
            if (isTouchDevice()) {
                let startX = 0;
                let startY = 0;
                let isScrolling = false;

                // 侧边栏滑动手势
                sidebar.addEventListener('touchstart', function (e) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    isScrolling = false;
                }, { passive: true });

                sidebar.addEventListener('touchmove', function (e) {
                    if (!startX || !startY) return;

                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const diffX = startX - currentX;
                    const diffY = startY - currentY;

                    // 判断是否为水平滑动
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        isScrolling = false;
                        // 向左滑动关闭侧边栏
                        if (diffX > 50 && isMobile()) {
                            sidebar.classList.add('sidebar-collapsed');
                        }
                    } else {
                        isScrolling = true;
                    }
                }, { passive: true });

                // 地图区域右滑显示侧边栏
                const mapContainer = document.getElementById('map-container');
                mapContainer.addEventListener('touchstart', function (e) {
                    if (!isMobile()) return;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });

                mapContainer.addEventListener('touchmove', function (e) {
                    if (!isMobile() || !startX) return;

                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const diffX = currentX - startX;
                    const diffY = startY - currentY;

                    // 从左边缘右滑显示侧边栏
                    if (startX < 50 && diffX > 100 && Math.abs(diffY) < 50) {
                        sidebar.classList.remove('sidebar-collapsed');
                    }
                }, { passive: true });
            }

            // 点击地图区域关闭侧边栏
            document.getElementById('map-container').addEventListener('click', function () {
                if (isMobile() && !sidebar.classList.contains('sidebar-collapsed')) {
                    sidebar.classList.add('sidebar-collapsed');
                }
            });

            // 窗口大小改变时的处理
            window.addEventListener('resize', function () {
                if (!isMobile()) {
                    sidebar.classList.remove('sidebar-collapsed');
                } else {
                    // 移动端默认隐藏侧边栏
                    if (!sidebar.classList.contains('sidebar-collapsed')) {
                        sidebar.classList.add('sidebar-collapsed');
                    }
                }
            });

            // 初始化移动端状态
            if (isMobile()) {
                sidebar.classList.add('sidebar-collapsed');
            }

            // 优化移动端地图交互
            if (isTouchDevice() && mapController) {
                // 禁用地图的某些手势以避免冲突
                mapController.map.setStatus({
                    doubleClickZoom: false, // 禁用双击缩放，避免误触
                });
            }
        }

        // 设置统计图表功能
        function setupStatistics() {
            const toggleButton = document.getElementById('toggle-stats');
            const statsContainer = document.getElementById('stats-container');
            let chartsInitialized = false;

            toggleButton.addEventListener('click', function () {
                if (statsContainer.classList.contains('hidden')) {
                    statsContainer.classList.remove('hidden');
                    toggleButton.textContent = '📊 隐藏统计图表';

                    if (!chartsInitialized) {
                        initializeCharts();
                        chartsInitialized = true;
                    }
                } else {
                    statsContainer.classList.add('hidden');
                    toggleButton.textContent = '📊 显示统计图表';
                }
            });
        }

        // 初始化统计图表
        function initializeCharts() {
            createDistanceChart();
            createLocationTypeChart();
        }

        // 创建每日驾驶里程图表
        function createDistanceChart() {
            const ctx = document.getElementById('distance-chart').getContext('2d');

            // 提取每日驾驶里程数据
            const labels = [];
            const distances = [];

            itineraryData.days.forEach(day => {
                labels.push(`第${day.day}天`);
                // 从驾驶距离字符串中提取数字
                const distanceMatch = day.drivingDistance.match(/(\d+)/);
                const distance = distanceMatch ? parseInt(distanceMatch[1]) : 0;
                distances.push(distance);
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '驾驶里程 (公里)',
                        data: distances,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // 创建地点类型分布图表
        function createLocationTypeChart() {
            const ctx = document.getElementById('location-chart').getContext('2d');

            // 统计地点类型
            const locationTypes = {};
            const typeNames = {
                'airport': '机场',
                'hotel': '酒店',
                'attraction': '景点',
                'restaurant': '餐厅',
                'city': '城市',
                'village': '村落',
                'viewpoint': '观景点',
                'transfer': '中转站',
                'departure': '出发点',
                'road': '道路',
                'landmark': '地标',
                'shopping': '购物'
            };

            itineraryData.days.forEach(day => {
                day.locations.forEach(location => {
                    const typeName = typeNames[location.type] || location.type;
                    locationTypes[typeName] = (locationTypes[typeName] || 0) + 1;
                });
            });

            const labels = Object.keys(locationTypes);
            const data = Object.values(locationTypes);
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E9', '#82E0AA', '#F8C471',
                '#D7BDE2', '#F9E79F'
            ];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                },
                                padding: 10,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // 显示主要景点
        function showMainAttractions() {
            if (!mapController) return;

            // 重置选中状态
            currentDay = null;
            document.querySelectorAll('.day-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'border-blue-300');
                item.classList.add('bg-gray-50');
            });

            // 清除覆盖物
            mapController.clearOverlays();

            // 只显示主要景点
            const mainAttractions = [];
            itineraryData.days.forEach(day => {
                day.locations.forEach(location => {
                    if (location.type === 'attraction' && location.coordinates) {
                        mapController.addMarker(location, day.day);
                        mainAttractions.push(location);
                    }
                });
            });

            // 调整视野
            mapController.fitViewToAllMarkers();

            console.log('显示主要景点，共', mainAttractions.length, '个');
        }

        // 选择特定天数
        function selectDay(dayNumber) {
            if (!mapController) return;

            currentDay = dayNumber;

            // 移除之前的选中状态
            document.querySelectorAll('.day-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'border-blue-300');
                item.classList.add('bg-gray-50');
            });

            // 添加选中状态
            const selectedItem = document.querySelector(`[data-day="${dayNumber}"]`);
            if (selectedItem) {
                selectedItem.classList.remove('bg-gray-50');
                selectedItem.classList.add('bg-blue-100', 'border-blue-300');
            }

            // 使用MapController显示特定天数
            mapController.displayDay(dayNumber);

            // 更新当前天数信息显示
            updateCurrentDayInfo(dayNumber);

            // 移动端自动隐藏侧边栏
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.add('sidebar-collapsed');
            }
        }

        // 更新当前天数信息显示
        function updateCurrentDayInfo(dayNumber) {
            const dayData = itineraryData.days.find(day => day.day === dayNumber);
            const infoDiv = document.getElementById('current-day-info');
            const contentDiv = document.getElementById('current-day-content');

            if (dayData) {
                contentDiv.innerHTML = `
                    <div class="text-sm">
                        <div class="font-bold text-gray-800 mb-1">第${dayData.day}天 - ${dayData.date}</div>
                        <div class="text-gray-600 mb-2">${dayData.title}</div>
                        <div class="flex items-center text-xs text-gray-500">
                            <span class="mr-3">🚗 ${dayData.drivingDistance}</span>
                            <span>⏱️ ${dayData.drivingTime}</span>
                        </div>
                    </div>
                `;
                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        // 高亮地图上的地点
        function highlightLocationOnMap(locationName, isHover = false) {
            if (!mapController) return;

            const marker = mapController.markers.find(m =>
                m.getExtData().location.name === locationName
            );

            if (marker) {
                if (isHover) {
                    // 悬停时只居中，不显示信息窗
                    mapController.map.setCenter(marker.getPosition(), true);

                    // 添加临时高亮效果
                    const originalIcon = marker.getIcon();
                    const location = marker.getExtData().location;
                    const highlightIcon = mapController.getHighlightMarkerIcon(location.type);
                    marker.setIcon(new AMap.Icon({
                        image: highlightIcon.image,
                        size: new AMap.Size(highlightIcon.size, highlightIcon.size),
                        imageSize: new AMap.Size(highlightIcon.size, highlightIcon.size)
                    }));

                    // 存储原始图标以便恢复
                    marker.originalIcon = originalIcon;
                } else {
                    // 点击时居中并显示信息窗
                    mapController.map.setCenter(marker.getPosition(), true);
                    mapController.showInfoWindow(marker, marker.getExtData().location);
                }
            }
        }

        // 清除地图高亮
        function clearMapHighlight() {
            if (!mapController) return;

            // 恢复所有标记的原始图标
            mapController.markers.forEach(marker => {
                if (marker.originalIcon) {
                    marker.setIcon(marker.originalIcon);
                    delete marker.originalIcon;
                }
            });
        }

        // 设置键盘快捷键
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function (e) {
                // 数字键1-9选择对应天数
                if (e.key >= '1' && e.key <= '9') {
                    const dayNumber = parseInt(e.key);
                    if (dayNumber <= itineraryData.totalDays) {
                        selectDay(dayNumber);
                    }
                }

                // 数字键0显示全部行程
                if (e.key === '0') {
                    showAllDays();
                }

                // ESC键关闭信息窗口和侧边栏
                if (e.key === 'Escape') {
                    if (mapController) {
                        mapController.infoWindows.forEach(infoWindow => {
                            infoWindow.close();
                        });
                    }

                    // 移动端关闭侧边栏
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.add('sidebar-collapsed');
                    }
                }

                // 左右箭头键切换天数
                if (currentDay && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                    e.preventDefault();
                    let newDay = currentDay;

                    if (e.key === 'ArrowLeft' && currentDay > 1) {
                        newDay = currentDay - 1;
                    } else if (e.key === 'ArrowRight' && currentDay < itineraryData.totalDays) {
                        newDay = currentDay + 1;
                    }

                    if (newDay !== currentDay) {
                        selectDay(newDay);
                    }
                }
            });
        }

        // 设置无障碍功能
        function setupAccessibility() {
            // 为所有交互元素添加适当的ARIA标签
            document.querySelectorAll('.day-item').forEach((item, index) => {
                item.setAttribute('role', 'button');
                item.setAttribute('tabindex', '0');
                item.setAttribute('aria-label', `选择第${index + 1}天行程`);

                // 添加键盘导航支持
                item.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const dayNumber = parseInt(item.dataset.day);
                        selectDay(dayNumber);
                    }
                });
            });

            // 为控制按钮添加ARIA标签
            document.getElementById('show-all-days').setAttribute('aria-label', '显示全部12天行程');
            document.getElementById('map-style-toggle').setAttribute('aria-label', '切换地图样式');

            // 为地图容器添加ARIA标签
            document.getElementById('map-container').setAttribute('role', 'application');
            document.getElementById('map-container').setAttribute('aria-label', '新疆12日自驾游交互式地图');

            // 添加跳过链接（对屏幕阅读器友好）
            const skipLink = document.createElement('a');
            skipLink.href = '#map-container';
            skipLink.textContent = '跳转到地图';
            skipLink.className = 'sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-500 text-white px-4 py-2 rounded z-50';
            document.body.insertBefore(skipLink, document.body.firstChild);
        }

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', function () {
            if (mapController) {
                mapController.destroy();
            }
        });

    </script>
</body>

</html>